<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DÃ©tails du Service â€” Pixel One</title>
  <link rel="icon" type="image/png" sizes="96x96" href="/icon/black/favicon-96x96.png" />
  <link rel="icon" type="image/svg+xml" href="/icon/black/favicon.svg" />
  <link rel="shortcut icon" href="/icon/black/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/icon/black/apple-touch-icon.png" />
  <link rel="manifest" href="/icon/black/site.webmanifest" />

  <!-- Theme Manager -->
  <script src="assets/js/theme-manager.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=IBM+Plex+Sans+Arabic:wght@300;400;500;700&display=swap" rel="stylesheet" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            brand: { DEFAULT: '#ff0000', dark: '#cc0000' },
            surface: { DEFAULT: '#0d0d0d', card: '#141414', border: '#1f1f1f' },
          },
          fontFamily: {
            sans:   ['Inter', 'sans-serif'],
            arabic: ['"IBM Plex Sans Arabic"', 'sans-serif'],
          },
        }
      }
    }
  </script>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    body { background-color: #050505; font-family: 'Inter', sans-serif; font-weight: 300; line-height: 1.6; }
    body.lang-fr { font-family: 'Inter', sans-serif; }
    body.lang-en { font-family: 'Inter', sans-serif; }
    body.lang-ar { font-family: 'IBM Plex Sans Arabic', sans-serif; }
    .site-logo { direction: ltr; unicode-bidi: isolate; }
    body::before {
      content: '';
      position: fixed; inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
      pointer-events: none; z-index: 0;
    }
    .content { position: relative; z-index: 1; }
    .upload-zone {
      border: 2px dashed #1f1f1f;
      transition: border-color .2s, background .2s;
    }
    .upload-zone.drag-over { border-color: #ff0000; background: rgba(255,0,0,0.05); }
  </style>
</head>

<body class="text-white lang-fr">
<div class="content">

  <!-- â”€â”€ NAVBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <nav id="main-nav" class="fixed top-0 left-0 right-0 z-50 bg-black/80 backdrop-blur-xl border-b border-white/[0.06] transition-shadow duration-300">
    <div class="max-w-7xl mx-auto px-4 sm:px-6">
      <div class="flex items-center justify-between h-16">
        <a href="index.html" dir="ltr" class="site-logo flex items-center gap-1.5 font-bold text-xl tracking-tight shrink-0">
          <span class="text-brand">Pixel</span><span>One</span>
        </a>
        <div class="hidden lg:flex items-center gap-7 text-sm text-gray-400">
          <a href="services.html" class="hover:text-white transition-colors duration-200" data-i18n="nav.services">Services</a>
          <a href="index.html#why" class="hover:text-white transition-colors duration-200" data-i18n="nav.why">Why Us</a>
          <a href="index.html#contact" class="hover:text-white transition-colors duration-200" data-i18n="nav.contact">Contact</a>
        </div>
        <div class="flex items-center gap-1.5 sm:gap-2">
          <button type="button" id="theme-toggle" onclick="toggleTheme(event)" class="w-9 h-9 rounded-lg flex items-center justify-center text-gray-400 hover:text-white hover:bg-white/[0.08] transition-all duration-200" aria-label="Toggle theme">
            <i id="theme-toggle-icon" class="theme-toggle-icon fa-solid fa-sun text-sm"></i>
          </button>
          <div class="relative" id="lang-dropdown-wrapper">
            <button id="lang-btn" class="flex items-center gap-1.5 h-9 px-2.5 rounded-lg border border-white/[0.08] hover:border-brand/30 text-gray-400 hover:text-white text-sm transition-all duration-200 cursor-pointer" aria-haspopup="listbox">
              <span id="lang-flag" class="text-base leading-none">ðŸ‡«ðŸ‡·</span>
              <span id="lang-code" class="font-medium text-xs tracking-wide hidden sm:inline">FR</span>
              <i class="fa-solid fa-chevron-down text-[8px] opacity-40"></i>
            </button>
            <div id="lang-dropdown" class="hidden absolute end-0 top-full mt-2 w-44 bg-[#161616] border border-[#282828] rounded-xl shadow-2xl overflow-hidden z-50" role="listbox">
              <button onclick="setLanguage('fr')" data-lang="fr" role="option" class="lang-opt w-full flex items-center gap-3 px-4 py-2.5 text-sm text-gray-300 hover:bg-brand/10 hover:text-white transition text-start">
                <span class="text-base leading-none">ðŸ‡«ðŸ‡·</span>
                <div class="text-start flex-1"><p class="font-semibold text-xs">FranÃ§ais</p><p class="text-[10px] text-gray-500" data-i18n="lang.fr.desc">FranÃ§ais</p></div>
              </button>
              <div class="h-px bg-[#282828]"></div>
              <button onclick="setLanguage('en')" data-lang="en" role="option" class="lang-opt w-full flex items-center gap-3 px-4 py-2.5 text-sm text-gray-300 hover:bg-brand/10 hover:text-white transition text-start">
                <span class="text-base leading-none">ðŸ‡ºðŸ‡¸</span>
                <div class="text-start flex-1"><p class="font-semibold text-xs">English</p><p class="text-[10px] text-gray-500" data-i18n="lang.en.desc">Anglais</p></div>
              </button>
              <div class="h-px bg-[#282828]"></div>
              <button onclick="setLanguage('ar')" data-lang="ar" role="option" class="lang-opt w-full flex items-center gap-3 px-4 py-2.5 text-sm text-gray-300 hover:bg-brand/10 hover:text-white transition text-start">
                <span class="text-base leading-none">ðŸ‡²ðŸ‡¦</span>
                <div class="text-start flex-1" style="font-family:'IBM Plex Sans Arabic',sans-serif"><p class="font-semibold text-xs">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</p><p class="text-[10px] text-gray-500" data-i18n="lang.ar.desc">Arabe</p></div>
              </button>
            </div>
          </div>
          <a href="services.html" class="hidden sm:flex items-center text-sm text-gray-400 hover:text-white transition-colors duration-200 px-2 py-1.5">
            <i class="fa-solid fa-arrow-left me-1.5 text-xs"></i><span data-i18n="detail.nav.services">Services</span>
          </a>
          <a href="dashboard.html" class="hidden sm:flex items-center bg-brand hover:bg-brand-dark text-white text-xs font-semibold uppercase tracking-widest px-4 py-2 rounded-lg transition-colors duration-200" data-i18n="detail.nav.myspace">Mon espace</a>
          <button id="mobile-menu-btn" onclick="toggleMobileMenu()" class="lg:hidden w-9 h-9 rounded-lg flex items-center justify-center text-gray-400 hover:text-white hover:bg-white/[0.08] transition-all duration-200" aria-label="Menu">
            <i class="fa-solid fa-bars text-sm"></i>
          </button>
        </div>
      </div>
    </div>
    <div id="mobile-menu" class="hidden lg:hidden border-t border-white/[0.06] bg-black/95 backdrop-blur-xl">
      <div class="max-w-7xl mx-auto px-4 py-3 space-y-1">
        <a href="services.html" class="block px-4 py-3 rounded-lg text-gray-300 hover:text-white hover:bg-white/[0.05] transition text-sm font-medium" data-i18n="nav.services">Services</a>
        <a href="index.html#why" class="block px-4 py-3 rounded-lg text-gray-300 hover:text-white hover:bg-white/[0.05] transition text-sm font-medium" data-i18n="nav.why">Pourquoi nous</a>
        <a href="index.html#contact" class="block px-4 py-3 rounded-lg text-gray-300 hover:text-white hover:bg-white/[0.05] transition text-sm font-medium" data-i18n="nav.contact">Contact</a>
        <div class="h-px bg-white/[0.06] my-2"></div>
        <a href="dashboard.html" class="block px-4 py-3 rounded-lg bg-brand/10 text-brand hover:bg-brand hover:text-white transition text-sm font-semibold text-center" data-i18n="detail.nav.myspace">Mon espace</a>
      </div>
    </div>
  </nav>

  <div class="pt-24 pb-16 px-6">
    <div class="max-w-6xl mx-auto">

      <!-- Loading / Error state -->
      <div id="loading-state" class="text-center py-20 text-gray-500">
        <i class="fa-solid fa-spinner fa-spin text-3xl mb-3"></i>
        <p data-i18n="detail.loading">Chargement du serviceâ€¦</p>
      </div>

      <!-- Main content (hidden until loaded) -->
      <div id="main-content" class="hidden">

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">

          <!-- LEFT â€” Service info -->
          <div>
            <a href="services.html" class="inline-flex items-center gap-2 text-sm text-gray-500 hover:text-white mb-6 transition">
              <i class="fa-solid fa-arrow-left text-xs"></i><span data-i18n="detail.back">Retour aux services</span>
            </a>

            <div class="relative rounded-2xl overflow-hidden mb-6">
              <img id="service-image" src="" alt=""
                   class="w-full h-64 object-cover" />
              <span id="service-category-badge"
                    class="absolute top-4 left-4 bg-black/70 backdrop-blur-sm text-xs text-gray-300 px-3 py-1 rounded-full border border-surface-border"></span>
            </div>

            <h1 id="service-title" class="text-3xl font-extrabold mb-3"></h1>
            <p class="text-brand font-extrabold text-4xl mb-6" id="service-price"></p>

            <div id="service-features" class="bg-surface-card border border-surface-border rounded-xl p-5 mb-6 space-y-2">
              <!-- Populated by JS -->
            </div>

            <!-- Trust badges -->
            <div class="grid grid-cols-3 gap-3 text-center">
              <div class="bg-surface-card border border-surface-border rounded-xl p-3">
                <i class="fa-solid fa-shield-halved text-brand mb-1"></i>
                <p class="text-xs text-gray-400" data-i18n="detail.trust.payment">Paiement sÃ©curisÃ©</p>
              </div>
              <div class="bg-surface-card border border-surface-border rounded-xl p-3">
                <i class="fa-solid fa-rotate text-brand mb-1"></i>
                <p class="text-xs text-gray-400" data-i18n="detail.trust.revisions">RÃ©visions incluses</p>
              </div>
              <div class="bg-surface-card border border-surface-border rounded-xl p-3">
                <i class="fa-brands fa-whatsapp text-green-500 mb-1"></i>
                <p class="text-xs text-gray-400" data-i18n="detail.trust.support">Support WhatsApp</p>
              </div>
            </div>
          </div>

          <!-- RIGHT â€” Order form -->
          <div class="bg-surface-card border border-surface-border rounded-2xl p-8">
            <h2 class="text-xl font-bold mb-6" data-i18n="detail.order.title">Commander ce service</h2>

            <!-- â”€â”€ Step 1: Details â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <div id="step-1">
              <form id="order-form" class="space-y-5">
                <input type="text" id="website" name="website" autocomplete="off" tabindex="-1" class="hidden" aria-hidden="true" />

                <!-- Common fields -->
                <div>
                  <label class="text-sm text-gray-400 mb-1.5 block" data-i18n="detail.form.name.label">Votre nom complet *</label>
                  <input id="field-name" type="text" required
                         data-i18n-ph="detail.form.name.ph"
                         placeholder="Mohamed Benali"
                         class="w-full bg-surface border border-surface-border rounded-lg px-4 py-3 text-sm text-white placeholder-gray-600 focus:outline-none focus:border-brand/50 transition" />
                </div>

                <div>
                  <label class="text-sm text-gray-400 mb-1.5 block" data-i18n="detail.form.phone.label">WhatsApp / TÃ©lÃ©phone *</label>
                  <input id="field-phone" type="tel" required
                         data-i18n-ph="detail.form.phone.ph"
                         placeholder="+212 6XX XXX XXX"
                         class="w-full bg-surface border border-surface-border rounded-lg px-4 py-3 text-sm text-white placeholder-gray-600 focus:outline-none focus:border-brand/50 transition" />
                </div>

                <div>
                  <label class="text-sm text-gray-400 mb-1.5 block" data-i18n="detail.form.email.label">Email *</label>
                  <input id="field-email" type="email" required
                         data-i18n-ph="detail.form.email.ph"
                         placeholder="email@exemple.com"
                         class="w-full bg-surface border border-surface-border rounded-lg px-4 py-3 text-sm text-white placeholder-gray-600 focus:outline-none focus:border-brand/50 transition" />
                </div>

                <!-- â”€â”€ SMART DYNAMIC FIELDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                <div id="dynamic-fields" class="space-y-5">
                  <!-- Injected based on category -->
                </div>

                <div>
                  <label class="text-sm text-gray-400 mb-1.5 block" data-i18n="detail.form.notes.label">Notes / DÃ©tails supplÃ©mentaires</label>
                  <textarea id="field-notes" rows="3"
                            data-i18n-ph="detail.form.notes.ph"
                            placeholder="DÃ©crivez vos besoins, couleurs, styleâ€¦"
                            class="w-full bg-surface border border-surface-border rounded-lg px-4 py-3 text-sm text-white placeholder-gray-600 focus:outline-none focus:border-brand/50 transition resize-none"></textarea>
                </div>

                <!-- Payment info -->
                <div class="bg-surface border border-brand/20 rounded-xl p-4">
                  <p class="text-xs text-gray-400 mb-2 font-semibold uppercase tracking-wider" data-i18n="detail.payment.title">Informations de paiement</p>
                  <p class="text-sm text-gray-300">
                    <i class="fa-solid fa-building-columns text-brand mr-2"></i>
                    Virement <strong id="bank-name"></strong> â€” <code id="bank-account" class="text-brand"></code>
                  </p>
                  <p class="text-sm text-gray-300 mt-1">
                    <i class="fa-solid fa-mobile-screen text-brand mr-2"></i>
                    CashPlus : <code id="cashplus-num" class="text-brand"></code>
                  </p>
                </div>

                <!-- Payment proof upload -->
                <div>
                  <label class="text-sm text-gray-400 mb-1.5 block" data-i18n="detail.upload.label">ReÃ§u de paiement *</label>
                  <div id="upload-zone"
                       class="upload-zone rounded-xl p-6 text-center cursor-pointer"
                       onclick="document.getElementById('proof-file').click()"
                       ondragover="handleDragOver(event)"
                       ondragleave="handleDragLeave(event)"
                       ondrop="handleDrop(event)">
                    <i class="fa-solid fa-cloud-arrow-up text-2xl text-gray-500 mb-2"></i>
                    <p class="text-sm text-gray-400"><span data-i18n="detail.upload.desc">Glissez votre reÃ§u ici ou</span> <span class="text-brand underline" data-i18n="detail.upload.browse">parcourir</span></p>
                    <p class="text-xs text-gray-600 mt-1" data-i18n="detail.upload.hint">JPG, PNG ou PDF â€” max 5 Mo</p>
                    <p id="file-name-display" class="text-xs text-brand mt-2 hidden"></p>
                    <input id="proof-file" type="file" accept="image/*,application/pdf" class="hidden"
                           onchange="handleFileSelect(this)" />
                  </div>
                </div>

                <button type="submit"
                        class="w-full bg-brand hover:bg-brand-dark text-white font-bold py-4 rounded-xl transition text-base">
                  <span data-i18n="detail.btn.submit">Confirmer la commande</span>
                  <i class="fa-solid fa-lock ml-2 text-sm"></i>
                </button>
              </form>
            </div>

            <!-- â”€â”€ Step 2: Success â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <div id="step-2" class="hidden text-center py-4">
              <div class="w-16 h-16 bg-green-500/10 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa-solid fa-check text-green-400 text-3xl"></i>
              </div>
              <h3 class="text-xl font-bold mb-2" data-i18n="detail.success.title">Commande enregistrÃ©e !</h3>
              <p class="text-gray-400 text-sm mb-2"><span data-i18n="detail.success.ref">RÃ©fÃ©rence :</span> <span id="order-ref-display" class="text-brand font-bold"></span></p>
              <p class="text-gray-400 text-sm mb-6" data-i18n="detail.success.whatsapp_desc">Notifiez l'Ã©quipe sur WhatsApp pour confirmer votre commande.</p>
              <a id="whatsapp-link" href="#" target="_blank"
                 class="inline-flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white font-bold px-6 py-3 rounded-xl transition mb-4">
                <i class="fa-brands fa-whatsapp text-xl"></i>
                <span data-i18n="detail.success.whatsapp_btn">Notifier sur WhatsApp</span>
              </a>
              <br/>
              <a href="dashboard.html"
                 class="text-sm text-gray-400 hover:text-white underline transition" data-i18n="detail.success.orders">
                Voir mes commandes â†’
              </a>
            </div>

          </div><!-- /order form -->
        </div><!-- /grid -->
      </div><!-- /main-content -->

    </div>
  </div>

</div><!-- /content -->

<script src="assets/js/config.js"></script>
<script src="assets/js/i18n.js"></script>
<script src="assets/js/supabase-client.js"></script>
<script src="assets/js/utils/error-handler.js"></script>
<script src="assets/js/utils/cache.js"></script>
<script src="assets/js/state/app-state.js"></script>
<script src="assets/js/api/services.api.js"></script>
<script src="assets/js/api/orders.api.js"></script>
<script>
  // â”€â”€ Parse service from URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const params = new URLSearchParams(window.location.search);
  const serviceId = parseInt(params.get('id'), 10);

  // Try to load from Supabase first; fall back to CONFIG.SERVICES
  async function loadService() {
    let service = null;

    try {
      const data = await ServicesAPI.getById(serviceId);
      if (data) {
        let features = data.features;
        if (!Array.isArray(features)) {
          try { features = JSON.parse(features || '[]'); } catch (_) { features = []; }
        }
        service = { ...data, features };
      }
    } catch (_) { /* Supabase not configured â€” fall back */ }

    if (!service) {
      service = CONFIG.SERVICES.find(s => s.id === serviceId);
    }

    if (!service) {
      document.getElementById('loading-state').innerHTML = `
        <i class="fa-solid fa-triangle-exclamation text-brand text-3xl mb-3"></i>
        <p class="text-gray-400">${t('detail.notfound')} <a href="services.html" class="text-brand underline">${t('detail.notfound.back')}</a></p>`;
      return;
    }

    renderService(service);
    // Track this view for the popular offers algorithm
    trackServiceView(service.id, service.category);
  }

  function renderService(s) {
    const lang = getLang();
    const title    = (s.titles && s.titles[lang]) || s.title;
    const features = (s.features_i18n && s.features_i18n[lang]) || s.features;

    document.title = `${title} â€” Pixel One`;
    document.getElementById('service-image').src = s.image_url;
    document.getElementById('service-image').alt = title;
    document.getElementById('service-title').textContent = title;
    document.getElementById('service-price').textContent = Number(s.price).toLocaleString('fr-FR') + ' MAD';
    document.getElementById('service-category-badge').textContent = t('cat.' + s.category);

    // Features list
    const featuresEl = document.getElementById('service-features');
    featuresEl.innerHTML = `<p class="text-xs text-gray-500 uppercase tracking-widest mb-3">${t('detail.features.title')}</p>` +
      features.map(f => `
        <div class="flex items-center gap-3">
          <i class="fa-solid fa-check-circle text-brand"></i>
          <span class="text-sm text-gray-300">${f}</span>
        </div>`).join('');

    // Payment info
    document.getElementById('bank-name').textContent = CONFIG.BANK_NAME;
    document.getElementById('bank-account').textContent = CONFIG.BANK_ACCOUNT;
    document.getElementById('cashplus-num').textContent = CONFIG.CASHPLUS_NUMBER;

    // Dynamic fields per category
    buildDynamicFields(s.category);

    // Store service ref for form submission
    document.getElementById('order-form').dataset.service = JSON.stringify(s);

    // Show content
    document.getElementById('loading-state').classList.add('hidden');
    document.getElementById('main-content').classList.remove('hidden');
  }

  // â”€â”€ Smart form builder (i18n-aware) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const DYNAMIC_FIELDS = {
    video: [
      { id: 'duration', labelKey: 'dynfield.video.duration.label', type: 'select',
        optKeys: ['dynfield.video.duration.opt1','dynfield.video.duration.opt2','dynfield.video.duration.opt3','dynfield.video.duration.opt4'] },
      { id: 'style', labelKey: 'dynfield.video.style.label', type: 'select',
        optKeys: ['dynfield.video.style.opt1','dynfield.video.style.opt2','dynfield.video.style.opt3','dynfield.video.style.opt4'] },
      { id: 'footage', labelKey: 'dynfield.video.footage.label', type: 'select',
        optKeys: ['dynfield.video.footage.opt1','dynfield.video.footage.opt2'] },
    ],
    design: [
      { id: 'format', labelKey: 'dynfield.design.format.label', type: 'select',
        optKeys: ['dynfield.design.format.opt1','dynfield.design.format.opt2','dynfield.design.format.opt3','dynfield.design.format.opt4'] },
      { id: 'colors', labelKey: 'dynfield.design.colors.label', type: 'text', phKey: 'dynfield.design.colors.ph' },
      { id: 'refs',   labelKey: 'dynfield.design.refs.label',   type: 'text', phKey: 'dynfield.design.refs.ph' },
    ],
    web: [
      { id: 'pages',  labelKey: 'dynfield.web.pages.label',  type: 'select',
        optKeys: ['dynfield.web.pages.opt1','dynfield.web.pages.opt2','dynfield.web.pages.opt3'] },
      { id: 'cms',    labelKey: 'dynfield.web.cms.label',    type: 'select',
        optKeys: ['dynfield.web.cms.opt1','dynfield.web.cms.opt2','dynfield.web.cms.opt3','dynfield.web.cms.opt4'] },
      { id: 'domain', labelKey: 'dynfield.web.domain.label', type: 'select',
        optKeys: ['dynfield.web.domain.opt1','dynfield.web.domain.opt2','dynfield.web.domain.opt3'] },
    ],
  };

  function buildDynamicFields(category) {
    const fields = DYNAMIC_FIELDS[category] || [];
    const container = document.getElementById('dynamic-fields');
    container.innerHTML = fields.map(f => {
      if (f.type === 'select') {
        return `
          <div>
            <label class="text-sm text-gray-400 mb-1.5 block">${t(f.labelKey)}</label>
            <select id="field-${f.id}"
                    class="w-full bg-surface border border-surface-border rounded-lg px-4 py-3 text-sm text-white focus:outline-none focus:border-brand/50 transition">
              ${f.optKeys.map(ok => `<option value="${t(ok)}">${t(ok)}</option>`).join('')}
            </select>
          </div>`;
      }
      return `
        <div>
          <label class="text-sm text-gray-400 mb-1.5 block">${t(f.labelKey)}</label>
          <input id="field-${f.id}" type="text" placeholder="${f.phKey ? t(f.phKey) : ''}"
                 class="w-full bg-surface border border-surface-border rounded-lg px-4 py-3 text-sm text-white placeholder-gray-600 focus:outline-none focus:border-brand/50 transition" />
        </div>`;
    }).join('');
  }

  // â”€â”€ File upload helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let selectedFile = null;

  function handleFileSelect(input) {
    if (input.files && input.files[0]) {
      selectedFile = input.files[0];
      showFileName(selectedFile.name);
    }
  }

  function handleDragOver(e) {
    e.preventDefault();
    document.getElementById('upload-zone').classList.add('drag-over');
  }

  function handleDragLeave(e) {
    document.getElementById('upload-zone').classList.remove('drag-over');
  }

  function handleDrop(e) {
    e.preventDefault();
    document.getElementById('upload-zone').classList.remove('drag-over');
    const file = e.dataTransfer.files[0];
    if (file) { selectedFile = file; showFileName(file.name); }
  }

  function showFileName(name) {
    const el = document.getElementById('file-name-display');
    el.textContent = 'âœ“ ' + name;
    el.classList.remove('hidden');
  }

  // â”€â”€ Form submission â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('order-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = e.target.querySelector('button[type="submit"]');
    btn.disabled = true;
    btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i>${t('detail.btn.processing')}`;

    if ((document.getElementById('website')?.value || '').trim() !== '') {
      btn.disabled = false;
      btn.innerHTML = `<span>${t('detail.btn.submit')}</span> <i class="fa-solid fa-lock ml-2 text-sm"></i>`;
      return;
    }

    const service = JSON.parse(e.target.dataset.service);

    // Collect common fields
    const name  = document.getElementById('field-name').value.trim();
    const phone = document.getElementById('field-phone').value.trim();
    const email = document.getElementById('field-email').value.trim();
    const notes = document.getElementById('field-notes').value.trim();

    // Collect dynamic fields
    const dynFields = DYNAMIC_FIELDS[service.category] || [];
    const extras = {};
    dynFields.forEach(f => {
      const el = document.getElementById(`field-${f.id}`);
      if (el) extras[f.id] = el.value;
    });

    const orderDetails = { name, phone, email, notes, ...extras };

    try {
      // Step 1: Enforce authentication
      const auth = await requireAuth(false);
      if (!auth || !auth.user) {
        alert(t('detail.err.auth'));
        btn.disabled = false;
        btn.innerHTML = `<span data-i18n="detail.btn.submit">${t('detail.btn.submit')}</span> <i class="fa-solid fa-lock ml-2 text-sm"></i>`;
        return;
      }

      const sb = getSupabaseClient();
      const userId = auth.user.id;

      // Step 2: Upload file and construct path
      if (!selectedFile) {
        alert(t('detail.err.noproof'));
        btn.disabled = false;
        btn.innerHTML = `<span data-i18n="detail.btn.submit">${t('detail.btn.submit')}</span> <i class="fa-solid fa-lock ml-2 text-sm"></i>`;
        return;
      }
      
      const ext = selectedFile.name.split('.').pop();
      const filePath = `${userId}/${Date.now()}-${Math.random().toString(36).slice(2, 8)}.${ext}`;
      const { error: uploadErr } = await sb.storage
        .from('payment-proofs')
        .upload(filePath, selectedFile, { upsert: false });

      if (uploadErr) throw uploadErr;
      
      const paymentProofPath = filePath;

      // Step 3: Insert order (order_ref generated by DB trigger)
      const createdOrder = await OrdersAPI.createOrder({
        user_id: userId,
        service_id: service.id,
        status: 'pending',
        details: orderDetails,
        payment_proof_path: paymentProofPath,
        payment_proof_url: null,
      });

      const orderRef = createdOrder?.order_ref || 'PX-XXXXXX';

      // Show success step
      document.getElementById('order-ref-display').textContent = orderRef;
      document.getElementById('whatsapp-link').href = buildWhatsAppLink({
        order_ref: orderRef,
        service_title: service.title,
        total: Number(service.price).toLocaleString('fr-FR'),
      });

      document.getElementById('step-1').classList.add('hidden');
      document.getElementById('step-2').classList.remove('hidden');

    } catch (err) {
      const safeMessage = await PixelOneErrorHandler.handleError(err, 'service-details:order-submit');
      alert(`${t('detail.err.general')}: ${safeMessage}`);
      btn.disabled = false;
      btn.innerHTML = `<span>${t('detail.btn.submit')}</span> <i class="fa-solid fa-lock ml-2 text-sm"></i>`;
    }
  });

  // Init
  loadService();
</script>
</body>
</html>
