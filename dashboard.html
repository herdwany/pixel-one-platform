<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mon Espace â€” Pixel One</title>
  <link rel="icon" type="image/png" sizes="96x96" href="/icon/black/favicon-96x96.png" />
  <link rel="icon" type="image/svg+xml" href="/icon/black/favicon.svg" />
  <link rel="shortcut icon" href="/icon/black/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/icon/black/apple-touch-icon.png" />
  <link rel="manifest" href="/icon/black/site.webmanifest" />

  <!-- Theme Manager -->


  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=IBM+Plex+Sans+Arabic:wght@300;400;500;700&display=swap" rel="stylesheet" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            brand: { DEFAULT: '#ff0000', dark: '#cc0000' },
            surface: { DEFAULT: '#0d0d0d', card: '#141414', border: '#1f1f1f' },
          },
          fontFamily: {
            sans:   ['Inter', 'sans-serif'],
            arabic: ['"IBM Plex Sans Arabic"', 'sans-serif'],
          },
        }
      }
    }
  </script>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="assets/css/ui-polish.css" />

  <style>
    body { background-color: #050505; font-family: 'Inter', sans-serif; font-weight: 300; line-height: 1.6; }
    body.lang-fr { font-family: 'Inter', sans-serif; }
    body.lang-en { font-family: 'Inter', sans-serif; }
    body.lang-ar { font-family: 'IBM Plex Sans Arabic', sans-serif; }
    .site-logo { direction: ltr; unicode-bidi: isolate; }
    body::before {
      content: '';
      position: fixed; inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
      pointer-events: none; z-index: 0;
    }
    .content { position: relative; z-index: 1; }

    /* Progress bar */
    .progress-step { flex: 1; text-align: center; }
    .progress-step .dot {
      width: 28px; height: 28px;
      border-radius: 50%;
      border: 2px solid #1f1f1f;
      display: flex; align-items: center; justify-content: center;
      margin: 0 auto 4px;
      font-size: 11px; font-weight: 700;
      transition: all .3s;
    }
    .progress-step.done .dot   { background: #22c55e; border-color: #22c55e; color: #fff; }
    .progress-step.active .dot { background: #ff0000; border-color: #ff0000; color: #fff; }
    .progress-step.pending .dot{ background: transparent; color: #555; }
    .progress-line { flex: 1; height: 2px; background: #1f1f1f; margin-top: -18px; }
    .progress-line.done { background: #22c55e; }
    .progress-line.active { background: linear-gradient(to right, #22c55e, #ff0000); }

    .status-badge { display: inline-flex; align-items: center; gap: 6px; font-size: 11px; font-weight: 600; padding: 4px 10px; border-radius: 9999px; }
    .status-pending     { background: rgba(234,179,8,0.1);  color: #eab308; border: 1px solid rgba(234,179,8,0.2); }
    .status-in_progress { background: rgba(59,130,246,0.1); color: #3b82f6; border: 1px solid rgba(59,130,246,0.2); }
    .status-review      { background: rgba(168,85,247,0.1); color: #a855f7; border: 1px solid rgba(168,85,247,0.2); }
    .status-done        { background: rgba(34,197,94,0.1);  color: #22c55e; border: 1px solid rgba(34,197,94,0.2); }
  </style>
</head>

<body class="text-white lang-fr">
<div class="content">

  <!-- â”€â”€ NAVBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <nav id="main-nav" class="fixed top-0 left-0 right-0 z-50 bg-black/80 backdrop-blur-xl border-b border-white/[0.06] transition-shadow duration-300">
    <div class="max-w-7xl mx-auto px-4 sm:px-6">
      <div class="flex items-center justify-between h-16">
        <a href="index.html" dir="ltr" class="site-logo flex items-center gap-1.5 font-bold text-xl tracking-tight shrink-0">
          <span class="text-brand">Pixel</span><span>One</span>
        </a>
        <div class="hidden lg:flex items-center gap-7 text-sm text-gray-400">
          <a href="index.html#services" class="hover:text-white transition-colors duration-200" data-i18n="nav.services">Services</a>
          <a href="services.html" class="hover:text-white transition-colors duration-200" data-i18n="nav.cta">Nos services</a>
        </div>
        <div class="flex items-center gap-1.5 sm:gap-2">
          <div class="relative" id="lang-dropdown-wrapper">
            <button id="lang-btn" class="flex items-center gap-1.5 h-9 px-2.5 rounded-lg border border-white/[0.08] hover:border-brand/30 text-gray-400 hover:text-white text-sm transition-all duration-200 cursor-pointer" aria-haspopup="listbox">
              <span id="lang-flag" class="text-base leading-none">ðŸ‡«ðŸ‡·</span>
              <span id="lang-code" class="font-medium text-xs tracking-wide hidden sm:inline">FR</span>
              <i class="fa-solid fa-chevron-down text-[8px] opacity-40"></i>
            </button>
            <div id="lang-dropdown" class="hidden absolute end-0 top-full mt-2 w-44 bg-[#161616] border border-[#282828] rounded-xl shadow-2xl overflow-hidden z-50" role="listbox">
              <button onclick="setLanguage('fr')" data-lang="fr" role="option" class="lang-opt w-full flex items-center gap-3 px-4 py-2.5 text-sm text-gray-300 hover:bg-brand/10 hover:text-white transition text-start">
                <span class="text-base leading-none">ðŸ‡«ðŸ‡·</span>
                <div class="text-start flex-1"><p class="font-semibold text-xs">FranÃ§ais</p><p class="text-[10px] text-gray-500" data-i18n="lang.fr.desc">FranÃ§ais</p></div>
              </button>
              <div class="h-px bg-[#282828]"></div>
              <button onclick="setLanguage('en')" data-lang="en" role="option" class="lang-opt w-full flex items-center gap-3 px-4 py-2.5 text-sm text-gray-300 hover:bg-brand/10 hover:text-white transition text-start">
                <span class="text-base leading-none">ðŸ‡ºðŸ‡¸</span>
                <div class="text-start flex-1"><p class="font-semibold text-xs">English</p><p class="text-[10px] text-gray-500" data-i18n="lang.en.desc">Anglais</p></div>
              </button>
              <div class="h-px bg-[#282828]"></div>
              <button onclick="setLanguage('ar')" data-lang="ar" role="option" class="lang-opt w-full flex items-center gap-3 px-4 py-2.5 text-sm text-gray-300 hover:bg-brand/10 hover:text-white transition text-start">
                <span class="text-base leading-none">ðŸ‡²ðŸ‡¦</span>
                <div class="text-start flex-1" style="font-family:'IBM Plex Sans Arabic',sans-serif"><p class="font-semibold text-xs">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</p><p class="text-[10px] text-gray-500" data-i18n="lang.ar.desc">Arabe</p></div>
              </button>
            </div>
          </div>
          <span id="user-name" class="hidden sm:inline text-sm text-gray-400"></span>
          <button id="logout-btn"
                  class="text-sm text-gray-500 hover:text-white border border-white/[0.08] hover:border-brand/40 px-3 py-1.5 rounded-lg transition">
            <i class="fa-solid fa-right-from-bracket me-1 text-xs"></i><span data-i18n="dash.logout">DÃ©connexion</span>
          </button>
          <button id="mobile-menu-btn" onclick="toggleMobileMenu()" class="lg:hidden w-9 h-9 rounded-lg flex items-center justify-center text-gray-400 hover:text-white hover:bg-white/[0.08] transition-all duration-200" aria-label="Menu">
            <i class="fa-solid fa-bars text-sm"></i>
          </button>
        </div>
      </div>
    </div>
    <div id="mobile-menu" class="hidden lg:hidden border-t border-white/[0.06] bg-black/95 backdrop-blur-xl">
      <div class="max-w-7xl mx-auto px-4 py-3 space-y-1">
        <a href="index.html#services" class="block px-4 py-3 rounded-lg text-gray-300 hover:text-white hover:bg-white/[0.05] transition text-sm font-medium" data-i18n="nav.services">Services</a>
        <a href="services.html" class="block px-4 py-3 rounded-lg bg-brand/10 text-brand hover:bg-brand hover:text-white transition text-sm font-semibold text-center" data-i18n="nav.cta">Nos services</a>
      </div>
    </div>
  </nav>

  <div class="pt-24 pb-16 px-6">
    <div class="max-w-5xl mx-auto">

      <!-- Header -->
      <div class="flex flex-col sm:flex-row sm:items-end justify-between gap-4 mb-10">
        <div>
          <h1 class="text-3xl font-extrabold mb-1"><span data-i18n="dash.header.title">Mon</span> <span class="text-brand" data-i18n="dash.header.accent">Espace</span></h1>
          <p class="text-gray-400 text-sm" data-i18n="dash.header.desc">Suivez l'avancement de vos commandes en temps rÃ©el.</p>
        </div>
        <a href="services.html"
           class="self-start sm:self-auto bg-brand hover:bg-brand-dark text-white text-sm font-bold px-5 py-2.5 rounded-xl transition">
          <i class="fa-solid fa-plus mr-1"></i><span data-i18n="dash.new.order">Nouvelle commande</span>
        </a>
      </div>

      <!-- Tab navigation -->
      <div class="flex gap-2 mb-8 flex-wrap">
        <button class="dash-tab active text-xs font-semibold px-4 py-2 rounded-lg border border-brand/40 bg-brand/10 text-white transition" data-tab="orders">
          <i class="fa-solid fa-list-check mr-1"></i>Mes Commandes
        </button>
        <button class="dash-tab text-xs font-semibold px-4 py-2 rounded-lg border border-surface-border bg-surface-card text-gray-400 hover:border-brand/40 transition" data-tab="profile">
          <i class="fa-solid fa-user mr-1"></i>Mon Profil
        </button>
        <button class="dash-tab text-xs font-semibold px-4 py-2 rounded-lg border border-surface-border bg-surface-card text-gray-400 hover:border-brand/40 transition relative" data-tab="notifications">
          <i class="fa-solid fa-bell mr-1"></i>Notifications
          <span id="notif-badge" class="absolute -top-1.5 -right-1.5 bg-brand text-white text-[10px] font-bold w-5 h-5 rounded-full flex items-center justify-center" style="display:none;">0</span>
        </button>
      </div>

      <div id="tab-orders" class="dash-tab-content">
        <!-- Loading -->
        <div id="loading-state" class="text-center py-16 text-gray-500">
          <i class="fa-solid fa-spinner fa-spin text-2xl mb-3"></i>
          <p data-i18n="dash.loading">Chargement de vos commandesâ€¦</p>
        </div>

        <!-- Empty state -->
        <div id="empty-state" class="hidden text-center py-16">
          <div class="w-16 h-16 bg-surface-card border border-surface-border rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fa-solid fa-inbox text-gray-600 text-2xl"></i>
          </div>
          <h3 class="font-bold text-lg mb-2" data-i18n="dash.empty.title">Aucune commande</h3>
          <p class="text-gray-500 text-sm mb-6" data-i18n="dash.empty.desc">Vous n'avez pas encore passÃ© de commande.</p>
          <a href="services.html" class="bg-brand hover:bg-brand-dark text-white font-bold px-6 py-3 rounded-xl transition" data-i18n="dash.empty.cta">
            DÃ©couvrir nos services
          </a>
        </div>

        <!-- Orders list -->
        <div id="orders-container" class="hidden space-y-6"></div>
      </div>

      <!-- â”€â”€ TAB: PROFILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div id="tab-profile" class="dash-tab-content hidden">
        <div class="bg-surface-card border border-surface-border rounded-2xl p-6 max-w-lg">
          <h2 class="font-bold text-lg mb-6"><i class="fa-solid fa-user-pen mr-2 text-brand"></i>Mon Profil</h2>

          <!-- Avatar -->
          <div class="flex items-center gap-5 mb-6">
            <div class="relative group">
              <div id="profile-avatar" class="w-20 h-20 rounded-full bg-brand/10 border-2 border-surface-border flex items-center justify-center text-brand text-2xl font-bold overflow-hidden">
                <span id="avatar-letter">?</span>
              </div>
              <label for="avatar-upload" class="absolute inset-0 rounded-full bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 cursor-pointer transition">
                <i class="fa-solid fa-camera text-white"></i>
              </label>
              <input type="file" id="avatar-upload" accept="image/png,image/jpeg,image/webp" class="hidden" />
            </div>
            <div>
              <p id="profile-display-name" class="font-semibold text-white">â€”</p>
              <p id="profile-display-email" class="text-sm text-gray-500">â€”</p>
              <p id="avatar-status" class="hidden text-xs text-green-400 mt-1"></p>
            </div>
          </div>

          <form id="profile-form" class="space-y-4">
            <div>
              <label class="text-xs text-gray-500 mb-1 block">Nom complet</label>
              <input id="profile-name" type="text" maxlength="100"
                     class="w-full bg-surface border border-surface-border rounded-lg px-4 py-2.5 text-sm text-white placeholder-gray-600 focus:outline-none focus:border-brand/50 transition"
                     placeholder="Votre nom" />
            </div>
            <div>
              <label class="text-xs text-gray-500 mb-1 block">TÃ©lÃ©phone</label>
              <input id="profile-phone" type="tel" maxlength="20"
                     class="w-full bg-surface border border-surface-border rounded-lg px-4 py-2.5 text-sm text-white placeholder-gray-600 focus:outline-none focus:border-brand/50 transition"
                     placeholder="0600000000" />
            </div>
            <button type="submit" class="bg-brand hover:bg-brand-dark text-white text-sm font-bold px-6 py-2.5 rounded-xl transition">
              <i class="fa-solid fa-save mr-2"></i>Enregistrer
            </button>
          </form>
          <div id="profile-alert" class="hidden mt-4 px-4 py-3 rounded-lg text-sm"></div>
        </div>
      </div>

      <!-- â”€â”€ TAB: NOTIFICATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div id="tab-notifications" class="dash-tab-content hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="font-bold text-lg"><i class="fa-solid fa-bell mr-2 text-brand"></i>Notifications</h2>
          <button id="mark-all-read-btn" class="hidden text-xs text-gray-400 hover:text-white border border-surface-border hover:border-brand/40 px-3 py-1.5 rounded-lg transition">
            <i class="fa-solid fa-check-double mr-1"></i>Tout marquer comme lu
          </button>
        </div>
        <div id="notifications-list" class="space-y-3">
          <div class="text-center py-10 text-gray-500">
            <i class="fa-solid fa-spinner fa-spin text-2xl"></i>
          </div>
        </div>
      </div>

    </div>
  </div>

</div><!-- /content -->

<script src="assets/js/config.js"></script>
<script src="assets/js/i18n.js"></script>
<script src="assets/js/supabase-client.js"></script>
<script src="assets/js/utils/error-handler.js"></script>
<script src="assets/js/api/orders.api.js"></script>
<script src="assets/js/api/users.api.js"></script>
<script src="assets/js/api/notifications.api.js"></script>
<script src="assets/js/api/storage.api.js"></script>
<script>
  // â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.querySelectorAll('.dash-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.dash-tab').forEach(t => {
        t.classList.remove('active', 'border-brand/40', 'bg-brand/10', 'text-white');
        t.classList.add('border-surface-border', 'bg-surface-card', 'text-gray-400');
      });
      tab.classList.add('active', 'border-brand/40', 'bg-brand/10', 'text-white');
      tab.classList.remove('border-surface-border', 'bg-surface-card', 'text-gray-400');
      document.querySelectorAll('.dash-tab-content').forEach(c => c.classList.add('hidden'));
      document.getElementById('tab-' + tab.dataset.tab).classList.remove('hidden');
    });
  });

  const STEPS = CONFIG.ORDER_STATUSES;

  function getStatusLabel(status) {
    return t('status.' + status) || status;
  }

  function statusBadge(status) {
    return `<span class="status-badge status-${status}">
      <i class="fa-solid fa-circle text-[6px]"></i>
      ${getStatusLabel(status)}
    </span>`;
  }

  function buildProgressBar(currentStatus) {
    const currentIdx = STEPS.indexOf(currentStatus);
    const allDone = currentStatus === 'done';
    let html = '<div class="flex items-start gap-0 mt-5">';

    STEPS.forEach((step, idx) => {
      let state = 'pending';
      if (allDone) {
        state = 'done';
      } else if (idx < currentIdx) {
        state = 'done';
      } else if (idx === currentIdx) {
        state = 'active';
      }

      const icon = state === 'done' ? '<i class="fa-solid fa-check"></i>' : (idx + 1);

      html += `
        <div class="progress-step ${state}">
          <div class="dot">${icon}</div>
          <p class="text-[10px] text-gray-500 leading-tight">${getStatusLabel(step)}</p>
        </div>`;

      if (idx < STEPS.length - 1) {
        let lineState = '';
        if (allDone) {
          lineState = 'done';
        } else if (idx < currentIdx) {
          lineState = 'done';
        } else if (idx === currentIdx) {
          lineState = 'active';
        }
        html += `<div class="progress-line ${lineState} self-center mx-1 flex-1"></div>`;
      }
    });

    html += '</div>';
    return html;
  }

  let _cachedOrders = [];

  async function renderOrders(orders) {
    _cachedOrders = orders;
    document.getElementById('loading-state').classList.add('hidden');

    if (!orders.length) {
      document.getElementById('empty-state').classList.remove('hidden');
      return;
    }

    const container = document.getElementById('orders-container');
    container.classList.remove('hidden');

    // Use pre-computed signed URLs stored in order._proofUrl
    const signedUrls = orders.map(order =>
      (order._proofUrl && order._proofUrl.startsWith('http')) ? order._proofUrl : null
    );

    renderOrdersHTML(orders, signedUrls);
  }

  function renderOrdersHTML(orders, signedUrls) {
    const container = document.getElementById('orders-container');
    const locale = getLang() === 'ar' ? 'ar-MA' : (getLang() === 'en' ? 'en-GB' : 'fr-FR');

    container.innerHTML = orders.map((order, idx) => {
      const service = order.services || {};
      const details = order.details || {};
      const date = new Date(order.created_at).toLocaleDateString(locale, { day:'2-digit', month:'short', year:'numeric' });
      const proofUrl = signedUrls[idx];

      return `
        <div class="bg-surface-card border border-surface-border rounded-2xl p-6 hover:border-brand/20 transition">
          <div class="flex flex-col sm:flex-row sm:items-start justify-between gap-4 mb-4">
            <div>
              <div class="flex items-center gap-3 mb-1">
                <span class="font-bold text-brand">${order.order_ref}</span>
                ${statusBadge(order.status)}
              </div>
              <p class="text-white font-semibold">${service.title || 'Service'}</p>
              <p class="text-gray-500 text-xs mt-0.5">${t('dash.order.date')} ${date}</p>
            </div>
            <div class="text-right">
              <p class="text-brand font-extrabold text-xl">${Number(service.price || 0).toLocaleString('fr-FR')} MAD</p>
              ${proofUrl
                ? `<a href="${proofUrl}" target="_blank"
                      class="text-xs text-gray-500 hover:text-white mt-1 inline-flex items-center gap-1 transition">
                     <i class="fa-solid fa-receipt"></i>${t('dash.order.receipt')}
                   </a>`
                : `<p class="text-xs text-yellow-500 mt-1"><i class="fa-solid fa-clock mr-1"></i>${t('dash.order.noproof')}</p>`}
            </div>
          </div>

          ${buildProgressBar(order.status)}

          ${Object.keys(details).length
            ? `<details class="mt-4">
                 <summary class="text-xs text-gray-500 cursor-pointer hover:text-white transition">${t('dash.order.details')}</summary>
                 <div class="mt-2 text-xs text-gray-400 bg-surface rounded-lg p-3 space-y-1">
                   ${Object.entries(details).map(([k,v]) => `<p><span class="text-gray-600">${k}:</span> ${v}</p>`).join('')}
                 </div>
               </details>`
            : ''}

          <div class="mt-4 flex gap-3">
            <a href="${buildWhatsAppLink({ order_ref: order.order_ref, service_title: service.title || 'Service', total: Number(service.price || 0).toLocaleString('fr-FR') })}"
               target="_blank"
               class="inline-flex items-center gap-2 text-xs text-green-400 hover:text-green-300 border border-green-500/20 hover:border-green-500/40 px-3 py-1.5 rounded-lg transition">
              <i class="fa-brands fa-whatsapp"></i>${t('dash.order.whatsapp')}
            </a>
          </div>
        </div>`;
    }).join('');
  }

  // Re-render orders when language changes (no need to re-fetch)
  document.addEventListener('langchange', () => {
    if (_cachedOrders.length) {
      // Re-render orders HTML using cached signed URLs stored in order._proofUrl
      const container = document.getElementById('orders-container');
      const locale = getLang() === 'ar' ? 'ar-MA' : (getLang() === 'en' ? 'en-GB' : 'fr-FR');
      container.innerHTML = _cachedOrders.map((order, idx) => {
        const service = order.services || {};
        const details = order.details || {};
        const date = new Date(order.created_at).toLocaleDateString(locale, { day:'2-digit', month:'short', year:'numeric' });
        const proofUrl = (order._proofUrl && order._proofUrl.startsWith('http')) ? order._proofUrl : null;

        return `
          <div class="bg-surface-card border border-surface-border rounded-2xl p-6 hover:border-brand/20 transition">
            <div class="flex flex-col sm:flex-row sm:items-start justify-between gap-4 mb-4">
              <div>
                <div class="flex items-center gap-3 mb-1">
                  <span class="font-bold text-brand">${order.order_ref}</span>
                  ${statusBadge(order.status)}
                </div>
                <p class="text-white font-semibold">${service.title || 'Service'}</p>
                <p class="text-gray-500 text-xs mt-0.5">${t('dash.order.date')} ${date}</p>
              </div>
              <div class="text-right">
                <p class="text-brand font-extrabold text-xl">${Number(service.price || 0).toLocaleString('fr-FR')} MAD</p>
                ${proofUrl
                  ? `<a href="${proofUrl}" target="_blank"
                        class="text-xs text-gray-500 hover:text-white mt-1 inline-flex items-center gap-1 transition">
                       <i class="fa-solid fa-receipt"></i>${t('dash.order.receipt')}
                     </a>`
                  : `<p class="text-xs text-yellow-500 mt-1"><i class="fa-solid fa-clock mr-1"></i>${t('dash.order.noproof')}</p>`}
              </div>
            </div>
            ${buildProgressBar(order.status)}
            ${Object.keys(details).length
              ? `<details class="mt-4">
                   <summary class="text-xs text-gray-500 cursor-pointer hover:text-white transition">${t('dash.order.details')}</summary>
                   <div class="mt-2 text-xs text-gray-400 bg-surface rounded-lg p-3 space-y-1">
                     ${Object.entries(details).map(([k,v]) => `<p><span class="text-gray-600">${k}:</span> ${v}</p>`).join('')}
                   </div>
                 </details>`
              : ''}
            <div class="mt-4 flex gap-3">
              <a href="${buildWhatsAppLink({ order_ref: order.order_ref, service_title: service.title || 'Service', total: Number(service.price || 0).toLocaleString('fr-FR') })}"
                 target="_blank"
                 class="inline-flex items-center gap-2 text-xs text-green-400 hover:text-green-300 border border-green-500/20 hover:border-green-500/40 px-3 py-1.5 rounded-lg transition">
                <i class="fa-brands fa-whatsapp"></i>${t('dash.order.whatsapp')}
              </a>
            </div>
          </div>`;
      }).join('');
    }
  });

  // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let _currentUser = null;
  let _currentProfile = null;

  (async () => {
    let user = null, profile = null;

    try {
      const auth = await requireAuth(false);
      if (!auth) return;
      user = auth.user;
      profile = auth.profile;
      _currentUser = user;
      _currentProfile = profile;
    } catch (err) {
      document.getElementById('loading-state').classList.add('hidden');
      document.getElementById('empty-state').classList.remove('hidden');
      return;
    }

    document.getElementById('user-name').textContent = profile?.full_name || user.email;

    // â”€â”€ Populate profile tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('profile-name').value = profile?.full_name || '';
    document.getElementById('profile-phone').value = profile?.phone || '';
    document.getElementById('profile-display-name').textContent = profile?.full_name || user.email;
    document.getElementById('profile-display-email').textContent = user.email;

    const avatarEl = document.getElementById('profile-avatar');
    const letterEl = document.getElementById('avatar-letter');
    if (profile?.avatar_url) {
      avatarEl.innerHTML = `<img src="${profile.avatar_url}" class="w-full h-full object-cover" alt="Avatar" />`;
    } else {
      letterEl.textContent = (profile?.full_name || user.email || '?')[0].toUpperCase();
    }

    // â”€â”€ Load orders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    try {
      const { rows: orders } = await OrdersAPI.listMyOrders({ page: 1, limit: 50 });

      const SIGNED_URL_EXPIRY_SECONDS = 60;
      const ordersWithUrls = await Promise.all((orders || []).map(async order => {
        let proofUrl = null;
        if (order.payment_proof_path) {
          proofUrl = await StorageAPI.createSignedUrl('payment-proofs', order.payment_proof_path, SIGNED_URL_EXPIRY_SECONDS);
        } else {
          proofUrl = order.payment_proof_url || null;
        }
        return { ...order, _proofUrl: proofUrl };
      }));

      await renderOrders(ordersWithUrls);
    } catch (err) {
      const loadingEl = document.getElementById('loading-state');
      loadingEl.classList.remove('hidden');
      loadingEl.innerHTML =
        `<div class="text-center">
          <p class="text-red-400 mb-4"><i class="fa-solid fa-triangle-exclamation mr-2"></i>${err.message}</p>
          <a href="auth.html" class="text-sm text-brand hover:underline">${t('dash.err.relogin')}</a>
        </div>`;
    }

    // â”€â”€ Load notifications â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    await loadNotifications();
  })();

  // â”€â”€ Profile form submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('profile-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const alertEl = document.getElementById('profile-alert');
    const name = document.getElementById('profile-name').value.trim();
    const phone = document.getElementById('profile-phone').value.trim();

    if (!_currentUser) return;

    try {
      await UsersAPI.updateMyProfile(_currentUser.id, {
        full_name: name.substring(0, 100),
        phone: phone.substring(0, 20),
      });

      document.getElementById('user-name').textContent = name || _currentUser.email;
      document.getElementById('profile-display-name').textContent = name || _currentUser.email;

      alertEl.textContent = 'Profil mis Ã  jour âœ“';
      alertEl.className = 'mt-4 px-4 py-3 rounded-lg text-sm bg-green-500/10 border border-green-500/30 text-green-400';
      alertEl.classList.remove('hidden');
      setTimeout(() => alertEl.classList.add('hidden'), 3000);
    } catch (err) {
      alertEl.textContent = 'âœ— ' + err.message;
      alertEl.className = 'mt-4 px-4 py-3 rounded-lg text-sm bg-red-500/10 border border-red-500/30 text-red-400';
      alertEl.classList.remove('hidden');
    }
  });

  // â”€â”€ Avatar upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('avatar-upload').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file || !_currentUser) return;

    const MAX_SIZE = 2 * 1024 * 1024; // 2MB
    if (file.size > MAX_SIZE) {
      alert('Image trop volumineuse (max 2MB)');
      return;
    }

    const statusEl = document.getElementById('avatar-status');
    statusEl.textContent = 'Upload en coursâ€¦';
    statusEl.classList.remove('hidden');

    try {
      const ext = file.name.split('.').pop().toLowerCase();
      const allowedExts = ['jpg', 'jpeg', 'png', 'webp'];
      if (!allowedExts.includes(ext)) {
        throw new Error('Format non supportÃ©. Utilisez JPG, PNG ou WebP.');
      }

      const path = `${_currentUser.id}/avatar.${ext}`;

      await StorageAPI.upload('avatars', path, file, { upsert: true, contentType: file.type });

      const avatarUrl = (StorageAPI.getPublicUrl('avatars', path) || '') + '?t=' + Date.now();

      await UsersAPI.updateMyProfile(_currentUser.id, { avatar_url: avatarUrl });

      document.getElementById('profile-avatar').innerHTML =
        `<img src="${avatarUrl}" class="w-full h-full object-cover" alt="Avatar" />`;

      statusEl.textContent = 'Photo mise Ã  jour âœ“';
      setTimeout(() => statusEl.classList.add('hidden'), 3000);
    } catch (err) {
      statusEl.textContent = 'âœ— ' + err.message;
      statusEl.className = 'text-xs text-red-400 mt-1';
      statusEl.classList.remove('hidden');
    }
  });

  // â”€â”€ Notifications â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadNotifications() {
    if (!_currentUser) return;
    const container = document.getElementById('notifications-list');
    try {
      const notifs = await NotificationsAPI.listMy({ userId: _currentUser.id, limit: 50 });
      const unreadCount = notifs.filter(n => !n.is_read).length;

      // Update badge
      const badge = document.getElementById('notif-badge');
      if (unreadCount > 0) {
        badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
        badge.classList.remove('hidden');
        document.getElementById('mark-all-read-btn').classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
        document.getElementById('mark-all-read-btn').classList.add('hidden');
      }

      if (!notifs.length) {
        container.innerHTML = `
          <div class="text-center py-10">
            <i class="fa-solid fa-bell-slash text-3xl text-gray-600 mb-3"></i>
            <p class="text-gray-500 text-sm">Aucune notification</p>
          </div>`;
        return;
      }

      const typeIcons = {
        order_update: 'fa-solid fa-box text-blue-400',
        reply: 'fa-solid fa-reply text-green-400',
        like: 'fa-solid fa-heart text-pink-400',
      };

      container.innerHTML = notifs.map(n => `
        <div class="flex items-start gap-4 p-4 rounded-xl border transition ${n.is_read ? 'bg-surface border-surface-border opacity-60' : 'bg-surface-card border-brand/20'}">
          <div class="w-9 h-9 rounded-full flex items-center justify-center shrink-0 ${n.is_read ? 'bg-surface-card' : 'bg-brand/10'}">
            <i class="${typeIcons[n.type] || 'fa-solid fa-bell text-gray-400'} text-sm"></i>
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-sm ${n.is_read ? 'text-gray-400' : 'text-white'}">${n.message}</p>
            <p class="text-[10px] text-gray-500 mt-1">${new Date(n.created_at).toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' })}</p>
          </div>
          ${!n.is_read ? `
            <button class="mark-read-btn text-xs text-gray-500 hover:text-white shrink-0" data-id="${n.id}">
              <i class="fa-solid fa-check"></i>
            </button>` : ''}
        </div>
      `).join('');

    } catch (err) {
      console.warn('[PixelOne] Notifications load error:', err.message);
      container.innerHTML = `<p class="text-gray-500 text-center py-10">Impossible de charger les notifications</p>`;
    }
  }

  // Mark single notification as read
  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.mark-read-btn');
    if (!btn || !_currentUser) return;
    try {
      await NotificationsAPI.markRead(btn.dataset.id);
      await loadNotifications();
    } catch (_) {}
  });

  // Mark all as read
  document.getElementById('mark-all-read-btn').addEventListener('click', async () => {
    if (!_currentUser) return;
    try {
      await NotificationsAPI.markAllRead(_currentUser.id);
      await loadNotifications();
    } catch (_) {}
  });

  // â”€â”€ Logout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('logout-btn').addEventListener('click', async () => {
    try {
      await getSupabaseClient().auth.signOut();
    } catch (_) {}
    window.location.href = 'auth.html';
  });
</script>
</body>
</html>
