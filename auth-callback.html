<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vérification — Pixel One</title>
  <link rel="icon" type="image/png" sizes="96x96" href="/icon/black/favicon-96x96.png" />
  <link rel="icon" type="image/svg+xml" href="/icon/black/favicon.svg" />
  <link rel="shortcut icon" href="/icon/black/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/icon/black/apple-touch-icon.png" />
  <link rel="manifest" href="/icon/black/site.webmanifest" />

  <!-- Theme Manager -->
  <script src="assets/js/theme-manager.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    body { background-color: #050505; color: white; display: flex; align-items: center; justify-content: center; height: 100vh; font-family: sans-serif; }
    .loader { animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="text-center">
    <i class="fa-solid fa-circle-notch text-4xl text-red-600 loader mb-4"></i>
    <h2 class="text-xl font-bold">Vérification en cours...</h2>
    <p class="text-gray-500 text-sm mt-2">Nous sécurisons votre connexion.</p>
  </div>

  <script src="assets/js/config.js"></script>
  <script src="assets/js/supabase-client.js"></script>
  <script>
    (async () => {
      const sb = getSupabaseClient();

      // فحص فوري للجلسة قبل انتظار التغيير
      const { data: { session: initialSession } } = await sb.auth.getSession();
      if (initialSession) {
        handleRedirect(initialSession.user);
        return;
      }

      const { data: { subscription } } = sb.auth.onAuthStateChange(async (event, session) => {
        if ((event === 'SIGNED_IN' || event === 'INITIAL_SESSION') && session) {
          subscription.unsubscribe();
          handleRedirect(session.user);
        }
      });

      async function handleRedirect(user) {
        try {
          const profile = await getProfile(user.id);
          window.location.href = profile?.role === 'admin' ? 'admin.html' : 'dashboard.html';
        } catch (err) {
          window.location.href = 'dashboard.html';
        }
      }

      // Timeout fallback
      setTimeout(() => {
        window.location.href = 'auth.html?timeout=true';
      }, 10000);
    })();
  </script>
</body>
</html>