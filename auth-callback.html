<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <title>Connexion...</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/config.js"></script>
    <style>body{background:#030303;color:#fff;display:flex;justify-content:center;align-items:center;height:100vh;margin:0;font-family:sans-serif}</style>
</head>
<body>
    <p>Authentification...</p>
    <script>
        // يجب أن تطابق إعدادات العميل هنا ملف supabase-client.js تماماً
        const supabase = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY, {
            auth: {
                persistSession: true,
                storageKey: 'pixelone-auth', // نفس المفتاح
                storage: window.localStorage,
                detectSessionInUrl: true
            }
        });

        supabase.auth.onAuthStateChange(async (event, session) => {
            if (session) {
                // حفظ الجلسة يدوياً للتأكيد
                localStorage.setItem('pixelone-auth', JSON.stringify(session));
                
                // التوجيه
                if (window.location.hash && window.location.hash.includes('type=recovery')) {
                    window.location.href = 'update-password.html';
                } else {
                    window.location.href = 'dashboard.html';
                }
            } else {
                // محاولة أخيرة لاستخراج الجلسة
                const { data } = await supabase.auth.getSession();
                if (data.session) {
                    window.location.href = 'dashboard.html';
                }
            }
        });
    </script>
</body>
</html>