<!DOCTYPE html>
<html lang="fr" class="dark scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin â€” Pixel One</title>
  <link rel="icon" type="image/png" sizes="96x96" href="/icon/black/favicon-96x96.png" />
  <link rel="icon" type="image/svg+xml" href="/icon/black/favicon.svg" />
  <link rel="shortcut icon" href="/icon/black/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/icon/black/apple-touch-icon.png" />
  <link rel="manifest" href="/icon/black/site.webmanifest" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=IBM+Plex+Sans+Arabic:wght@300;400;500;700&display=swap" rel="stylesheet" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            brand: { DEFAULT: '#ff0000', dark: '#cc0000' },
            surface: { DEFAULT: '#0d0d0d', card: '#141414', border: '#1f1f1f' },
          },
          fontFamily: {
            sans:   ['Inter', 'sans-serif'],
            arabic: ['"IBM Plex Sans Arabic"', 'sans-serif'],
          },
        }
      }
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tiny.cloud/1/rntzzdmktbe63s135bjt48b3sh8j2shokgic6ijzova4h248/tinymce/8/tinymce.min.js" referrerpolicy="origin" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="assets/css/ui-polish.css" />

  <style>
    body { background-color: #050505; color: white; font-family: 'Inter', sans-serif; font-weight: 300; line-height: 1.6; }
    body.lang-fr { font-family: 'Inter', sans-serif; }
    body.lang-en { font-family: 'Inter', sans-serif; }
    body.lang-ar { font-family: 'IBM Plex Sans Arabic', sans-serif; }
    .site-logo { direction: ltr; unicode-bidi: isolate; }
    
    body::before {
      content: '';
      position: fixed; inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
      pointer-events: none; z-index: 0;
    }
    .content { position: relative; z-index: 1; }
    
    .status-badge { font-size: 11px; font-weight: 600; padding: 3px 9px; border-radius: 9999px; }
    .status-pending     { background: rgba(234,179,8,0.1);  color: #eab308; }
    .status-in_progress { background: rgba(59,130,246,0.1); color: #3b82f6; }
    .status-review      { background: rgba(168,85,247,0.1); color: #a855f7; }
    .status-done        { background: rgba(34,197,94,0.1);  color: #22c55e; }

    #modal-overlay { transition: opacity .2s; }
    #modal-overlay.hidden { pointer-events: none; opacity: 0; }

    .nav-item { display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 10px; cursor: pointer; transition: all .2s; font-size: 14px; color: #9ca3af; }
    .nav-item:hover, .nav-item.active { background: rgba(255,0,0,0.08); color: #fff; }
    .nav-item.active i { color: #ff0000; }
  </style>
</head>

<body class="text-white lang-fr">
<div class="content flex h-screen overflow-hidden">

  <aside class="w-64 shrink-0 bg-surface-card border-r border-surface-border flex flex-col py-6 px-4">
    <a href="index.html" dir="ltr" class="site-logo font-bold text-lg tracking-tight mb-8 px-2 flex items-center justify-between">
      <span><span class="text-brand">Pixel</span>One <span class="text-xs text-gray-500 font-normal">Admin</span></span>
    </a>

    <nav class="flex-1 space-y-1">
      <div class="nav-item active" data-section="orders">
        <i class="fa-solid fa-list-check w-4"></i><span data-i18n="admin.nav.orders">Commandes</span>
      </div>
      <div class="nav-item" data-section="services">
        <i class="fa-solid fa-briefcase w-4"></i><span data-i18n="admin.nav.services">Services</span>
      </div>
      <div class="nav-item" data-section="blog">
        <i class="fa-solid fa-pen-to-square w-4"></i><span data-i18n="admin.nav.blog">Blog</span>
      </div>
      <div class="nav-item" data-section="stats">
        <i class="fa-solid fa-chart-bar w-4"></i><span data-i18n="admin.nav.stats">Statistiques</span>
      </div>
      <div class="nav-item" data-section="comments">
        <i class="fa-solid fa-comments w-4"></i><span>Commentaires</span>
      </div>
      <div class="nav-item" data-section="users">
        <i class="fa-solid fa-users w-4"></i><span>Utilisateurs</span>
      </div>
      <div class="nav-item" data-section="content">
        <i class="fa-solid fa-file-lines w-4"></i><span>Contenu du site</span>
      </div>
    </nav>

    <div class="border-t border-surface-border pt-4 space-y-1">
      <a href="dashboard.html" class="nav-item"><i class="fa-solid fa-user w-4"></i><span data-i18n="admin.nav.client">Vue client</span></a>
      <button id="logout-btn" class="nav-item w-full text-left text-red-500 hover:bg-red-500/10 hover:text-red-400">
        <i class="fa-solid fa-right-from-bracket w-4"></i><span data-i18n="admin.nav.logout">DÃ©connexion</span>
      </button>
    </div>
  </aside>

  <main class="flex-1 overflow-y-auto">

    <div class="sticky top-0 z-10 bg-black/70 backdrop-blur-md border-b border-surface-border px-8 py-4 flex items-center justify-between">
      <h1 id="section-title" class="font-bold text-lg" data-i18n="admin.orders.title">Commandes</h1>
      <div class="flex items-center gap-3">
        <div class="relative" id="lang-dropdown-wrapper">
          <button id="lang-btn"
                  class="flex items-center gap-1.5 h-9 px-2.5 rounded-lg border border-white/[0.08] hover:border-brand/30 text-gray-400 hover:text-white text-sm transition-all duration-200 cursor-pointer"
                  aria-haspopup="listbox">
            <span id="lang-flag" class="text-base leading-none">ğŸ‡«ğŸ‡·</span>
            <span id="lang-code" class="font-medium text-xs tracking-wide">FR</span>
            <i class="fa-solid fa-chevron-down text-[8px] opacity-40"></i>
          </button>
          <div id="lang-dropdown"
               class="hidden absolute end-0 top-full mt-2 w-44 bg-[#161616] border border-[#282828] rounded-xl shadow-2xl overflow-hidden z-50"
               role="listbox">
            <button onclick="setLanguage('fr')" data-lang="fr" role="option"
                    class="lang-opt w-full flex items-center gap-3 px-4 py-2.5 text-sm text-gray-300 hover:bg-brand/10 hover:text-white transition text-start">
              <span class="text-base leading-none">ğŸ‡«ğŸ‡·</span>
              <div class="text-start flex-1"><p class="font-semibold text-xs">FranÃ§ais</p></div>
            </button>
            <div class="h-px bg-[#282828]"></div>
            <button onclick="setLanguage('en')" data-lang="en" role="option"
                    class="lang-opt w-full flex items-center gap-3 px-4 py-2.5 text-sm text-gray-300 hover:bg-brand/10 hover:text-white transition text-start">
              <span class="text-base leading-none">ğŸ‡ºğŸ‡¸</span>
              <div class="text-start flex-1"><p class="font-semibold text-xs">English</p></div>
            </button>
            <div class="h-px bg-[#282828]"></div>
            <button onclick="setLanguage('ar')" data-lang="ar" role="option"
                    class="lang-opt w-full flex items-center gap-3 px-4 py-2.5 text-sm text-gray-300 hover:bg-brand/10 hover:text-white transition text-start">
              <span class="text-base leading-none">ğŸ‡²ğŸ‡¦</span>
              <div class="text-start flex-1" style="font-family:'IBM Plex Sans Arabic',sans-serif"><p class="font-semibold text-xs">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</p></div>
            </button>
          </div>
        </div>
        
        <span id="admin-name" class="text-sm text-gray-400"></span>
        <span class="bg-brand/10 border border-brand/30 text-brand text-xs font-semibold px-3 py-1 rounded-full">God Mode</span>
      </div>
    </div>

    <div class="p-8 space-y-8">
      <div id="stats-row" class="grid grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="bg-surface-card border border-surface-border rounded-xl p-5">
          <p class="text-2xl font-extrabold text-brand" id="stat-total">â€”</p>
          <p class="text-gray-500 text-xs mt-1" data-i18n="admin.stat.total">Commandes totales</p>
        </div>
        <div class="bg-surface-card border border-surface-border rounded-xl p-5">
          <p class="text-2xl font-extrabold text-yellow-400" id="stat-pending">â€”</p>
          <p class="text-gray-500 text-xs mt-1" data-i18n="admin.stat.pending">En attente</p>
        </div>
        <div class="bg-surface-card border border-surface-border rounded-xl p-5">
          <p class="text-2xl font-extrabold text-blue-400" id="stat-progress">â€”</p>
          <p class="text-gray-500 text-xs mt-1" data-i18n="admin.stat.progress">En cours</p>
        </div>
        <div class="bg-surface-card border border-surface-border rounded-xl p-5">
          <p class="text-2xl font-extrabold text-green-400" id="stat-done">â€”</p>
          <p class="text-gray-500 text-xs mt-1" data-i18n="admin.stat.done">TerminÃ©es</p>
        </div>
      </div>

      <section id="section-orders" class="space-y-4">
        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3 justify-between">
          <div class="flex gap-2 flex-wrap" id="status-filter-btns">
            <button class="status-filter-btn active text-xs font-semibold px-3 py-1.5 rounded-lg border border-surface-border bg-surface-card hover:border-brand/40" data-status="" data-i18n="admin.filter.all">Toutes</button>
            <button class="status-filter-btn text-xs font-semibold px-3 py-1.5 rounded-lg border border-surface-border bg-surface-card hover:border-brand/40" data-status="pending" data-i18n="admin.filter.pending">En attente</button>
            <button class="status-filter-btn text-xs font-semibold px-3 py-1.5 rounded-lg border border-surface-border bg-surface-card hover:border-brand/40" data-status="in_progress" data-i18n="admin.filter.progress">En cours</button>
            <button class="status-filter-btn text-xs font-semibold px-3 py-1.5 rounded-lg border border-surface-border bg-surface-card hover:border-brand/40" data-status="review" data-i18n="admin.filter.review">RÃ©vision</button>
            <button class="status-filter-btn text-xs font-semibold px-3 py-1.5 rounded-lg border border-surface-border bg-surface-card hover:border-brand/40" data-status="done" data-i18n="admin.filter.done">TerminÃ©es</button>
          </div>
          <input id="order-search" type="text" placeholder="Rechercher..." class="bg-surface border border-surface-border rounded-lg px-3 py-2 text-sm text-white placeholder-gray-600 focus:outline-none focus:border-brand/50 w-48" />
        </div>
        <div id="orders-loading" class="text-center py-10 text-gray-500"><i class="fa-solid fa-spinner fa-spin text-2xl"></i></div>
        <div id="orders-table-wrap" class="hidden bg-surface-card border border-surface-border rounded-2xl overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="border-b border-surface-border text-gray-500 text-xs uppercase">
                <tr>
                  <th class="text-left px-5 py-3" data-i18n="admin.table.ref">RÃ©f.</th>
                  <th class="text-left px-5 py-3" data-i18n="admin.table.client">Client</th>
                  <th class="text-left px-5 py-3" data-i18n="admin.table.service">Service</th>
                  <th class="text-left px-5 py-3" data-i18n="admin.table.status">Statut</th>
                  <th class="text-left px-5 py-3" data-i18n="admin.table.date">Date</th>
                  <th class="text-left px-5 py-3" data-i18n="admin.table.actions">Actions</th>
                </tr>
              </thead>
              <tbody id="orders-tbody" class="divide-y divide-surface-border"></tbody>
            </table>
          </div>
        </div>
        <div class="flex items-center justify-end gap-2">
          <button id="orders-prev-btn" class="text-xs font-semibold px-3 py-1.5 rounded-lg border border-surface-border bg-surface-card text-gray-300 disabled:opacity-40" disabled>Prev</button>
          <span id="orders-page-label" class="text-xs text-gray-500">Page 1</span>
          <button id="orders-next-btn" class="text-xs font-semibold px-3 py-1.5 rounded-lg border border-surface-border bg-surface-card text-gray-300 disabled:opacity-40" disabled>Next</button>
        </div>
      </section>

      <section id="section-services" class="hidden space-y-6">
        <div class="flex items-center justify-between">
          <h2 class="font-bold text-lg" data-i18n="admin.services.title">Gestion des Services</h2>
          <button id="add-service-btn" class="bg-brand hover:bg-brand-dark text-white text-sm font-bold px-4 py-2 rounded-xl transition">
            <i class="fa-solid fa-plus mr-1"></i><span data-i18n="admin.services.add">Ajouter</span>
          </button>
        </div>
        <div class="flex gap-2 flex-wrap">
          <button class="admin-svc-filter active text-xs font-semibold px-3 py-1.5 rounded-lg border border-brand/40 bg-brand/10 text-white" data-filter="active">Actifs</button>
          <button class="admin-svc-filter text-xs font-semibold px-3 py-1.5 rounded-lg border border-surface-border bg-surface-card text-gray-400 hover:border-brand/40" data-filter="coming_soon">BientÃ´t</button>
          <button class="admin-svc-filter text-xs font-semibold px-3 py-1.5 rounded-lg border border-surface-border bg-surface-card text-gray-400 hover:border-brand/40" data-filter="all">Tous</button>
        </div>
        <div id="services-admin-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </section>

      <section id="section-blog" class="hidden space-y-4">
        <div class="flex items-center justify-between">
          <h2 class="font-bold text-lg" data-i18n="admin.blog.title">Gestion du Blog</h2>
          <button id="add-blog-btn" class="bg-brand hover:bg-brand-dark text-white text-sm font-bold px-4 py-2 rounded-xl transition">
            <i class="fa-solid fa-plus mr-1"></i><span data-i18n="admin.blog.add">Nouvel article</span>
          </button>
        </div>
        <div id="blog-posts-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </section>

      <section id="section-stats" class="hidden">
        <h2 class="font-bold text-lg mb-6" data-i18n="admin.stats.title">Statistiques</h2>
        <div id="stats-charts" class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="bg-surface-card border border-surface-border rounded-2xl p-6">
            <h3 class="text-sm font-semibold text-gray-400 mb-4 uppercase tracking-wider" data-i18n="admin.stats.by_status">Commandes par statut</h3>
            <div id="stat-by-status" class="space-y-3"></div>
          </div>
          <div class="bg-surface-card border border-surface-border rounded-2xl p-6">
            <h3 class="text-sm font-semibold text-gray-400 mb-4 uppercase tracking-wider" data-i18n="admin.stats.by_cat">Revenus par catÃ©gorie</h3>
            <div id="stat-by-category" class="space-y-3"></div>
          </div>
        </div>
      </section>

      <section id="section-comments" class="hidden space-y-4">
        <div class="flex items-center justify-between">
          <h2 class="font-bold text-lg">Commentaires</h2>
          <div class="flex gap-2 flex-wrap justify-end">
            <button class="comment-filter-btn active text-xs font-semibold px-3 py-1.5 rounded-lg border border-brand/40 bg-brand/10 text-white" data-filter="all">Tous</button>
            <button class="comment-filter-btn text-xs font-semibold px-3 py-1.5 rounded-lg border border-surface-border bg-surface-card text-gray-400" data-filter="pending">En attente</button>
            <button class="comment-filter-btn text-xs font-semibold px-3 py-1.5 rounded-lg border border-surface-border bg-surface-card text-gray-400" data-filter="approved">ApprouvÃ©s</button>
            <button id="bulk-approve-comments-btn" class="text-xs font-semibold px-3 py-1.5 rounded-lg border border-green-500/30 bg-green-500/10 text-green-400">Tout approuver</button>
          </div>
        </div>
        <div id="comments-admin-list" class="space-y-3">
          <div class="text-center py-10 text-gray-500"><i class="fa-solid fa-spinner fa-spin text-2xl"></i></div>
        </div>
        <div class="flex items-center justify-end gap-2">
          <button id="comments-prev-btn" class="text-xs font-semibold px-3 py-1.5 rounded-lg border border-surface-border bg-surface-card text-gray-300 disabled:opacity-40" disabled>Prev</button>
          <span id="comments-page-label" class="text-xs text-gray-500">Page 1</span>
          <button id="comments-next-btn" class="text-xs font-semibold px-3 py-1.5 rounded-lg border border-surface-border bg-surface-card text-gray-300 disabled:opacity-40" disabled>Next</button>
        </div>
      </section>

      <section id="section-users" class="hidden space-y-4">
        <h2 class="font-bold text-lg">Utilisateurs</h2>
        <div id="users-loading" class="text-center py-10 text-gray-500"><i class="fa-solid fa-spinner fa-spin text-2xl"></i></div>
        <div id="users-table-wrap" class="hidden overflow-x-auto bg-surface-card border border-surface-border rounded-2xl">
          <table class="w-full text-sm">
            <thead class="text-xs text-gray-500 uppercase tracking-wider border-b border-surface-border">
              <tr>
                <th class="text-left px-5 py-3">Avatar</th>
                <th class="text-left px-5 py-3">Nom</th>
                <th class="text-left px-5 py-3">Email</th>
                <th class="text-left px-5 py-3">TÃ©lÃ©phone</th>
                <th class="text-left px-5 py-3">Inscription</th>
                <th class="text-left px-5 py-3">Actions</th>
              </tr>
            </thead>
            <tbody id="users-tbody"></tbody>
          </table>
        </div>
        <div class="flex items-center justify-end gap-2">
          <button id="users-prev-btn" class="text-xs font-semibold px-3 py-1.5 rounded-lg border border-surface-border bg-surface-card text-gray-300 disabled:opacity-40" disabled>Prev</button>
          <span id="users-page-label" class="text-xs text-gray-500">Page 1</span>
          <button id="users-next-btn" class="text-xs font-semibold px-3 py-1.5 rounded-lg border border-surface-border bg-surface-card text-gray-300 disabled:opacity-40" disabled>Next</button>
        </div>
      </section>

      <section id="section-content" class="hidden space-y-4">
        <div class="flex items-center justify-between">
          <h2 class="font-bold text-lg">Contenu du site</h2>
          <button id="save-content-btn" class="bg-brand hover:bg-brand-dark text-white text-sm font-bold px-4 py-2 rounded-xl transition">
            <i class="fa-solid fa-save mr-1"></i>Enregistrer
          </button>
        </div>
        <div id="content-loading" class="text-center py-10 text-gray-500"><i class="fa-solid fa-spinner fa-spin text-2xl"></i></div>
        <div id="content-sections" class="space-y-6 hidden"></div>
        <div id="content-alert" class="hidden px-4 py-3 rounded-lg text-sm"></div>
      </section>

    </div>
  </main>
</div>

<div id="modal-overlay" class="hidden fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4" role="dialog" aria-modal="true">
  <div class="bg-surface-card border border-surface-border rounded-2xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
    <div class="flex items-center justify-between mb-5">
      <h3 id="modal-title" class="font-bold text-lg" data-i18n="admin.modal.title">Modifier</h3>
      <button id="modal-close" class="text-gray-500 hover:text-white transition"><i class="fa-solid fa-xmark text-xl"></i></button>
    </div>
    <div class="space-y-4">
      <div><label class="text-sm text-gray-400 mb-1.5 block">RÃ©fÃ©rence</label><p id="modal-ref" class="text-brand font-bold"></p></div>
      <div class="bg-surface rounded-xl p-4">
        <p class="text-xs text-gray-500 uppercase tracking-widest font-semibold mb-3">Client</p>
        <div class="grid grid-cols-2 gap-3 text-sm">
          <div><p class="text-gray-500 text-xs">Nom</p><p id="modal-client-name" class="text-white font-medium mt-0.5">â€”</p></div>
          <div><p class="text-gray-500 text-xs">TÃ©l</p><p id="modal-client-phone" class="text-white font-medium mt-0.5">â€”</p></div>
          <div class="col-span-2"><p class="text-gray-500 text-xs">Email</p><p id="modal-client-email" class="text-white font-medium mt-0.5">â€”</p></div>
        </div>
      </div>
      <div id="modal-order-details" class="hidden bg-surface rounded-xl p-4">
        <p class="text-xs text-gray-500 uppercase tracking-widest font-semibold mb-3">DÃ©tails</p>
        <div id="modal-details-content" class="text-sm space-y-1.5 text-gray-300"></div>
      </div>
      <div id="modal-proof-wrap" class="hidden">
        <p class="text-xs text-gray-500 uppercase tracking-widest font-semibold mb-2">Preuve</p>
        <div id="modal-proof-content"></div>
      </div>
      <div>
        <label class="text-sm text-gray-400 mb-1.5 block">Statut</label>
        <select id="modal-status" class="w-full bg-surface border border-surface-border rounded-lg px-4 py-3 text-sm text-white focus:outline-none focus:border-brand/50 transition">
          <option value="pending">En attente</option>
          <option value="in_progress">En cours</option>
          <option value="review">En rÃ©vision</option>
          <option value="done">TerminÃ©</option>
        </select>
      </div>
      <button id="modal-save" class="w-full bg-brand hover:bg-brand-dark text-white font-bold py-3 rounded-xl transition">Enregistrer</button>
    </div>
  </div>
</div>

<div id="svc-modal-overlay" class="hidden fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4" role="dialog" aria-modal="true">
  <div class="bg-surface-card border border-surface-border rounded-2xl w-full max-w-2xl p-6 max-h-[90vh] overflow-y-auto">
    <div class="flex items-center justify-between mb-5">
      <h3 id="svc-modal-title" class="font-bold text-lg">Ajouter un Service</h3>
      <button id="svc-modal-close" class="text-gray-500 hover:text-white transition"><i class="fa-solid fa-xmark text-xl"></i></button>
    </div>
    <form id="svc-form" class="space-y-5">
      <div class="flex gap-2 border-b border-surface-border pb-3">
        <button type="button" class="svc-form-tab active text-xs font-semibold px-3 py-1.5 rounded-lg bg-brand/10 border border-brand/30 text-white" data-tab="info"><i class="fa-solid fa-info-circle mr-1"></i>Infos</button>
        <button type="button" class="svc-form-tab text-xs font-semibold px-3 py-1.5 rounded-lg bg-surface border border-surface-border text-gray-400" data-tab="i18n"><i class="fa-solid fa-language mr-1"></i>Traduction</button>
        <button type="button" class="svc-form-tab text-xs font-semibold px-3 py-1.5 rounded-lg bg-surface border border-surface-border text-gray-400" data-tab="options"><i class="fa-solid fa-sliders mr-1"></i>Options</button>
      </div>
      <div id="svc-tab-info" class="svc-tab-content space-y-4">
        <div><label class="text-sm text-gray-400 mb-1.5 block">Titre (FR)</label><input id="svc-title" type="text" required class="w-full bg-surface border border-surface-border rounded-lg px-4 py-3 text-sm text-white focus:outline-none focus:border-brand/50 transition" /></div>
        <div><label class="text-sm text-gray-400 mb-1.5 block">Description (FR)</label><textarea id="svc-description" rows="2" class="w-full bg-surface border border-surface-border rounded-lg px-4 py-3 text-sm text-white focus:outline-none focus:border-brand/50 transition resize-none"></textarea></div>
        <div class="grid grid-cols-2 gap-4">
          <div><label class="text-sm text-gray-400 mb-1.5 block">CatÃ©gorie</label><select id="svc-category" class="w-full bg-surface border border-surface-border rounded-lg px-4 py-3 text-sm text-white focus:outline-none focus:border-brand/50 transition"><option value="video">VidÃ©o</option><option value="design">Design</option><option value="web">Web</option></select></div>
          <div><label class="text-sm text-gray-400 mb-1.5 block">Prix</label><input id="svc-price" type="number" step="0.01" required class="w-full bg-surface border border-surface-border rounded-lg px-4 py-3 text-sm text-white focus:outline-none focus:border-brand/50 transition" /></div>
        </div>
        <div><label class="text-sm text-gray-400 mb-1.5 block">Image (URL)</label><input id="svc-image" type="url" class="w-full bg-surface border border-surface-border rounded-lg px-4 py-3 text-sm text-white focus:outline-none focus:border-brand/50 transition" /><div id="svc-image-preview" class="mt-2 hidden"><img id="svc-image-preview-img" src="" class="w-full h-32 object-cover rounded-lg border border-surface-border" /></div></div>
        <div><label class="text-sm text-gray-400 mb-1.5 block">CaractÃ©ristiques (FR)</label><textarea id="svc-features" rows="4" class="w-full bg-surface border border-surface-border rounded-lg px-4 py-3 text-sm text-white focus:outline-none focus:border-brand/50 transition resize-none"></textarea></div>
      </div>
      <div id="svc-tab-i18n" class="svc-tab-content hidden space-y-4">
        <div><label class="text-sm text-gray-400 mb-1 block">Title (EN)</label><input id="svc-title-en" type="text" class="w-full bg-surface border border-surface-border rounded-lg px-4 py-2.5 text-sm text-white focus:outline-none focus:border-brand/50 transition" /></div>
        <div><label class="text-sm text-gray-400 mb-1 block">Description (EN)</label><textarea id="svc-desc-en" rows="2" class="w-full bg-surface border border-surface-border rounded-lg px-4 py-2.5 text-sm text-white focus:outline-none focus:border-brand/50 transition resize-none"></textarea></div>
        <div><label class="text-sm text-gray-400 mb-1 block">Features (EN)</label><textarea id="svc-features-en" rows="3" class="w-full bg-surface border border-surface-border rounded-lg px-4 py-2.5 text-sm text-white focus:outline-none focus:border-brand/50 transition resize-none"></textarea></div>
        <div><label class="text-sm text-gray-400 mb-1 block">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (AR)</label><input id="svc-title-ar" type="text" dir="rtl" class="w-full bg-surface border border-surface-border rounded-lg px-4 py-2.5 text-sm text-white focus:outline-none focus:border-brand/50 transition" /></div>
        <div><label class="text-sm text-gray-400 mb-1 block">Ø§Ù„ÙˆØµÙ (AR)</label><textarea id="svc-desc-ar" rows="2" dir="rtl" class="w-full bg-surface border border-surface-border rounded-lg px-4 py-2.5 text-sm text-white focus:outline-none focus:border-brand/50 transition resize-none"></textarea></div>
        <div><label class="text-sm text-gray-400 mb-1 block">Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª (AR)</label><textarea id="svc-features-ar" rows="3" dir="rtl" class="w-full bg-surface border border-surface-border rounded-lg px-4 py-2.5 text-sm text-white focus:outline-none focus:border-brand/50 transition resize-none"></textarea></div>
      </div>
      <div id="svc-tab-options" class="svc-tab-content hidden space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div><label class="text-sm text-gray-400 mb-1.5 block">Livraison</label><input id="svc-delivery" type="text" class="w-full bg-surface border border-surface-border rounded-lg px-4 py-3 text-sm text-white focus:outline-none focus:border-brand/50 transition" /></div>
          <div><label class="text-sm text-gray-400 mb-1.5 block">RÃ©visions</label><input id="svc-revisions" type="number" min="0" class="w-full bg-surface border border-surface-border rounded-lg px-4 py-3 text-sm text-white focus:outline-none focus:border-brand/50 transition" /></div>
        </div>
        <div><label class="text-sm text-gray-400 mb-1.5 block">Ordre</label><input id="svc-sort" type="number" class="w-full bg-surface border border-surface-border rounded-lg px-4 py-3 text-sm text-white focus:outline-none focus:border-brand/50 transition" /></div>
        <div class="grid grid-cols-2 gap-4 bg-surface rounded-xl p-4">
          <div class="flex items-center gap-3"><input id="svc-active" type="checkbox" checked class="accent-brand w-4 h-4" /><label for="svc-active" class="text-sm text-white font-medium cursor-pointer">Actif</label></div>
          <div class="flex items-center gap-3"><input id="svc-coming-soon" type="checkbox" class="accent-yellow-400 w-4 h-4" /><label for="svc-coming-soon" class="text-sm text-white font-medium cursor-pointer">BientÃ´t</label></div>
        </div>
      </div>
      <div id="svc-alert" class="hidden px-4 py-3 rounded-lg text-sm"></div>
      <button type="submit" class="w-full bg-brand hover:bg-brand-dark text-white font-bold py-3 rounded-xl transition"><span id="svc-submit-text">Enregistrer</span></button>
    </form>
  </div>
</div>

<div id="blog-modal-overlay" class="hidden fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4" role="dialog" aria-modal="true">
  <div class="bg-surface-card border border-surface-border rounded-2xl w-full max-w-6xl p-8 max-h-[92vh] overflow-y-auto">
    <div class="flex items-center justify-between mb-5">
      <h3 id="blog-modal-title" class="font-bold text-lg">Nouvel article</h3>
      <button id="blog-modal-close" class="text-gray-500 hover:text-white transition"><i class="fa-solid fa-xmark text-xl"></i></button>
    </div>
    <form id="blog-form" class="space-y-4">
      <div class="flex gap-1 bg-surface rounded-lg p-1 border border-surface-border">
        <button type="button" class="blog-lang-tab flex-1 text-xs font-semibold py-2 rounded-md transition bg-brand/10 text-white border border-brand/40" data-blog-lang="fr">ğŸ‡«ğŸ‡· FR</button>
        <button type="button" class="blog-lang-tab flex-1 text-xs font-semibold py-2 rounded-md transition text-gray-500 border border-transparent hover:text-white" data-blog-lang="en">ğŸ‡ºğŸ‡¸ EN</button>
        <button type="button" class="blog-lang-tab flex-1 text-xs font-semibold py-2 rounded-md transition text-gray-500 border border-transparent hover:text-white" data-blog-lang="ar">ğŸ‡²ğŸ‡¦ AR</button>
      </div>
      <div id="blog-fields-fr" class="blog-lang-fields space-y-4">
        <div><label class="text-sm text-gray-400 mb-1.5 block">Titre (FR)</label><input id="blog-title" type="text" required class="w-full bg-surface border border-surface-border rounded-lg px-4 py-3 text-sm text-white focus:outline-none focus:border-brand/50 transition" /></div>
        <div><label class="text-sm text-gray-400 mb-1.5 block">Contenu (FR)</label><textarea id="blog-content" rows="14" class="w-full bg-surface border border-surface-border rounded-lg px-4 py-3 text-sm text-white focus:outline-none focus:border-brand/50 transition resize-y"></textarea></div>
      </div>
      <div id="blog-fields-en" class="blog-lang-fields space-y-4 hidden">
        <div><label class="text-sm text-gray-400 mb-1.5 block">Title (EN)</label><input id="blog-title-en" type="text" class="w-full bg-surface border border-surface-border rounded-lg px-4 py-3 text-sm text-white focus:outline-none focus:border-brand/50 transition" /></div>
        <div><label class="text-sm text-gray-400 mb-1.5 block">Content (EN)</label><textarea id="blog-content-en" rows="14" class="w-full bg-surface border border-surface-border rounded-lg px-4 py-3 text-sm text-white focus:outline-none focus:border-brand/50 transition resize-y"></textarea></div>
      </div>
      <div id="blog-fields-ar" class="blog-lang-fields space-y-4 hidden">
        <div><label class="text-sm text-gray-400 mb-1.5 block">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (AR)</label><input id="blog-title-ar" type="text" dir="rtl" class="w-full bg-surface border border-surface-border rounded-lg px-4 py-3 text-sm text-white focus:outline-none focus:border-brand/50 transition" /></div>
        <div><label class="text-sm text-gray-400 mb-1.5 block">Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (AR)</label><textarea id="blog-content-ar" rows="14" dir="rtl" class="w-full bg-surface border border-surface-border rounded-lg px-4 py-3 text-sm text-white focus:outline-none focus:border-brand/50 transition resize-y"></textarea></div>
      </div>
      <div><label class="text-sm text-gray-400 mb-1.5 block">Slug</label><input id="blog-slug" type="text" required class="w-full bg-surface border border-surface-border rounded-lg px-4 py-3 text-sm text-white focus:outline-none focus:border-brand/50 transition" /></div>
      <div><label class="text-sm text-gray-400 mb-1.5 block">Image</label><input id="blog-image" type="url" class="w-full bg-surface border border-surface-border rounded-lg px-4 py-3 text-sm text-white focus:outline-none focus:border-brand/50 transition" /></div>
      <div><label class="text-sm text-gray-400 mb-1.5 block">Video</label><input id="blog-video-url" type="url" class="w-full bg-surface border border-surface-border rounded-lg px-4 py-3 text-sm text-white focus:outline-none focus:border-brand/50 transition" /></div>
      <div class="flex items-center gap-3"><label class="text-sm text-gray-400">PubliÃ©</label><input id="blog-published" type="checkbox" checked class="accent-brand w-4 h-4" /></div>
      <div id="blog-alert" class="hidden mt-4 px-4 py-3 rounded-lg text-sm"></div>
      <button type="submit" class="w-full bg-brand hover:bg-brand-dark text-white font-bold py-3 rounded-xl transition"><span id="blog-submit-text">Publier</span></button>
    </form>
  </div>
</div>

<script src="assets/js/config.js"></script>
<script src="assets/js/i18n.js"></script>
<script src="assets/js/supabase-client.js"></script>
<script src="assets/js/utils/error-handler.js"></script>
<script src="assets/js/utils/cache.js"></script>
<script src="assets/js/state/app-state.js"></script>
<script src="assets/js/api/orders.api.js"></script>
<script src="assets/js/api/services.api.js"></script>
<script src="assets/js/api/blog.api.js"></script>
<script src="assets/js/api/users.api.js"></script>
<script src="assets/js/admin/admin-orders.js"></script>
<script src="assets/js/admin/admin-users.js"></script>
<script src="assets/js/admin/admin-blog.js"></script>
<script src="assets/js/admin/admin-comments.js"></script>
<script src="assets/js/admin/admin-services.js"></script>
<script src="assets/js/admin/admin-site-content.js"></script>

<script>
  let allOrders = [], activeStatusFilter = '', currentOrderId = null, adminOrdersPage = 1, adminOrdersTotal = 0;
  const ADMIN_PAGE_LIMIT = 10;
  function esc(str){return String(str??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}

  // --- INIT & AUTH BYPASS ---
  (async () => {
    let profile = null;
    try {
      // ğŸ›‘ğŸ›‘ HERE IS THE FIX: requireAuth(false) bypasses role check ğŸ›‘ğŸ›‘
      const auth = await requireAuth(false); 
      if (!auth) return;
      profile = auth.profile;
      document.getElementById('admin-name').textContent = profile?.full_name || auth.user.email;
    } catch (err) { console.warn('Auth skipped:', err); }

    await loadOrdersPage(1);
    try { const s = await AdminServicesModule.listAll(); renderAdminServices((s||[]).map(parseSvcJsonFields)); } catch(_){ renderAdminServices(CONFIG.SERVICES); }
    await loadBlogPosts();
    await loadAdminComments();
    await loadSiteContent();
    await loadUsers();
  })();

  // --- Navigation ---
  const sections = {orders:null,services:null,blog:null,stats:null,comments:null,users:null,content:null};
  document.querySelectorAll('.nav-item[data-section]').forEach(item => {
    item.addEventListener('click', () => {
      document.querySelectorAll('.nav-item[data-section]').forEach(n=>n.classList.remove('active'));
      item.classList.add('active');
      const sec = item.dataset.section;
      const span = item.querySelector('[data-i18n]');
      document.getElementById('section-title').textContent = span ? span.textContent.trim() : item.textContent.trim();
      Object.keys(sections).forEach(k => document.getElementById(`section-${k}`)?.classList.toggle('hidden', k!==sec));
    });
  });

  document.getElementById('logout-btn').addEventListener('click', async () => {
    try{await getSupabaseClient().auth.signOut();}catch(_){}
    window.location.href = 'auth.html';
  });

  // --- ORDERS ---
  async function loadOrdersPage(page=1){
    adminOrdersPage = page;
    try{
      const {rows,count} = await AdminOrdersModule.list(page, ADMIN_PAGE_LIMIT);
      allOrders = rows||[]; adminOrdersTotal = count||0;
    }catch(err){await PixelOneErrorHandler.handleError(err,'admin:orders');allOrders=[];adminOrdersTotal=0;}
    document.getElementById('orders-loading').classList.add('hidden');
    document.getElementById('orders-table-wrap').classList.remove('hidden');
    renderOrders(allOrders);
    updateStats(allOrders);
    updatePager('orders-page-label','orders-prev-btn','orders-next-btn',adminOrdersPage,adminOrdersTotal,ADMIN_PAGE_LIMIT);
  }
  function updatePager(lid,pid,nid,page,total,limit){
    const tp=Math.max(1,Math.ceil((total||0)/limit));
    const l=document.getElementById(lid); if(l)l.textContent=`Page ${page}/${tp}`;
    document.getElementById(pid).disabled=page<=1;
    document.getElementById(nid).disabled=page>=tp;
  }
  async function renderOrders(orders){
    const search=document.getElementById('order-search').value.toLowerCase();
    let list=orders;
    if(activeStatusFilter) list=list.filter(o=>o.status===activeStatusFilter);
    if(search) list=list.filter(o=>(o.order_ref||'').toLowerCase().includes(search)||(o.services?.title||'').toLowerCase().includes(search));
    const tbody=document.getElementById('orders-tbody');
    if(!list.length){tbody.innerHTML=`<tr><td colspan="6" class="text-center py-10 text-gray-500">Vide</td></tr>`;return;}
    
    // Signed URLs (simplified)
    const sb=getSupabaseClient();
    const signedUrls=await Promise.all(list.map(async o=>{
       if(o.payment_proof_path){
         try{const{data}=await sb.storage.from('payment-proofs').createSignedUrl(o.payment_proof_path,300);return data?.signedUrl||o.payment_proof_url;}catch(_){return o.payment_proof_url;}
       }
       return o.payment_proof_url;
    }));

    tbody.innerHTML=list.map((o,i)=>{
      const date=new Date(o.created_at).toLocaleDateString('fr-FR');
      const name=esc(o.details?.name||o.profiles?.full_name||'â€”');
      const st=o.status;
      return `<tr class="hover:bg-surface/40 transition">
        <td class="px-5 py-3 font-bold text-brand text-xs">${esc(o.order_ref)}</td>
        <td class="px-5 py-3 text-xs text-gray-300">${name}</td>
        <td class="px-5 py-3 text-xs text-gray-300">${esc(o.services?.title||'â€”')}</td>
        <td class="px-5 py-3"><select class="order-status-select bg-surface border border-surface-border text-xs rounded-lg px-2 py-1 text-white" data-id="${o.id}">${CONFIG.ORDER_STATUSES.map(s=>`<option value="${s}" ${s===st?'selected':''}>${t('status.'+s)||s}</option>`).join('')}</select></td>
        <td class="px-5 py-3 text-xs text-gray-500">${date}</td>
        <td class="px-5 py-3 flex gap-2">
          <button class="edit-order-btn text-xs text-brand" data-id="${o.id}"><i class="fa-solid fa-pen"></i></button>
          <button class="del-order-btn text-xs text-red-500" data-id="${o.id}"><i class="fa-solid fa-trash"></i></button>
          ${signedUrls[i]?`<a href="${signedUrls[i]}" target="_blank" class="text-xs text-gray-400"><i class="fa-solid fa-file"></i></a>`:''}
        </td></tr>`;
    }).join('');
  }
  function updateStats(orders){
    document.getElementById('stat-total').textContent=orders.length;
    document.getElementById('stat-pending').textContent=orders.filter(o=>o.status==='pending').length;
    document.getElementById('stat-progress').textContent=orders.filter(o=>o.status==='in_progress').length;
    document.getElementById('stat-done').textContent=orders.filter(o=>o.status==='done').length;
  }
  document.getElementById('orders-tbody').addEventListener('change', async e=>{
    if(e.target.classList.contains('order-status-select')){
      try{await AdminOrdersModule.updateStatus(Number(e.target.dataset.id), e.target.value); await loadOrdersPage(adminOrdersPage);}catch(err){alert(err.message);}
    }
  });
  document.addEventListener('click', async e=>{
    if(e.target.closest('.del-order-btn')){
      if(confirm('Supprimer?')) {await AdminOrdersModule.remove(Number(e.target.closest('.del-order-btn').dataset.id)); await loadOrdersPage(adminOrdersPage);}
    }
    if(e.target.closest('.edit-order-btn')){
      currentOrderId=Number(e.target.closest('.edit-order-btn').dataset.id);
      const o=allOrders.find(x=>x.id===currentOrderId);
      if(o){
        document.getElementById('modal-ref').textContent=o.order_ref;
        document.getElementById('modal-status').value=o.status;
        document.getElementById('modal-client-name').textContent=o.details?.name||o.profiles?.full_name||'â€”';
        document.getElementById('modal-client-email').textContent=o.details?.email||'â€”';
        document.getElementById('modal-client-phone').textContent=o.details?.phone||'â€”';
        document.getElementById('modal-overlay').classList.remove('hidden');
      }
    }
  });
  document.getElementById('modal-close').addEventListener('click', ()=>document.getElementById('modal-overlay').classList.add('hidden'));
  document.getElementById('modal-save').addEventListener('click', async ()=>{
    try{await AdminOrdersModule.updateStatus(currentOrderId, document.getElementById('modal-status').value); await loadOrdersPage(adminOrdersPage); document.getElementById('modal-overlay').classList.add('hidden');}catch(err){alert(err.message);}
  });
  document.querySelectorAll('.status-filter-btn').forEach(b=>b.addEventListener('click',()=>{
    document.querySelectorAll('.status-filter-btn').forEach(x=>x.classList.remove('active','border-brand/40','text-white'));
    b.classList.add('active','border-brand/40','text-white'); activeStatusFilter=b.dataset.status; renderOrders(allOrders);
  }));
  document.getElementById('order-search').addEventListener('input', ()=>renderOrders(allOrders));
  document.getElementById('orders-prev-btn').addEventListener('click', ()=>adminOrdersPage>1&&loadOrdersPage(adminOrdersPage-1));
  document.getElementById('orders-next-btn').addEventListener('click', ()=>adminOrdersPage<Math.ceil(adminOrdersTotal/ADMIN_PAGE_LIMIT)&&loadOrdersPage(adminOrdersPage+1));

  // --- SERVICES ---
  let adminServices=[], adminSvcFilter='active', editServiceId=null;
  function parseSvcJsonFields(s){return {...s,features:typeof s.features==='string'?JSON.parse(s.features||'[]'):s.features, titles:typeof s.titles==='string'?JSON.parse(s.titles||'{}'):s.titles};}
  function renderAdminServices(svcs){
    adminServices=svcs; const grid=document.getElementById('services-admin-grid');
    let f=svcs; if(adminSvcFilter==='active')f=f.filter(s=>s.is_active!==false&&!s.is_coming_soon); else if(adminSvcFilter==='coming_soon')f=f.filter(s=>s.is_coming_soon);
    grid.innerHTML=f.map(s=>`
      <div class="bg-surface border border-surface-border rounded-xl overflow-hidden p-4">
        <div class="flex justify-between mb-2"><span class="text-xs text-gray-400">${s.category}</span><span class="text-brand font-bold text-sm">${s.price} MAD</span></div>
        <p class="font-bold text-sm truncate mb-4">${esc(s.title)}</p>
        <div class="flex gap-2"><button class="edit-svc-btn flex-1 text-xs border border-surface-border rounded py-1" data-id="${s.id}">Modif</button><button class="del-svc-btn text-xs text-red-500 border border-surface-border rounded px-2 py-1" data-id="${s.id}"><i class="fa-solid fa-trash"></i></button></div>
      </div>`).join('');
  }
  document.querySelectorAll('.admin-svc-filter').forEach(b=>b.addEventListener('click',()=>{
    document.querySelectorAll('.admin-svc-filter').forEach(x=>x.classList.remove('active','border-brand/40','text-white'));
    b.classList.add('active','border-brand/40','text-white'); adminSvcFilter=b.dataset.filter; renderAdminServices(adminServices);
  }));
  document.getElementById('add-service-btn').addEventListener('click', ()=>openSvcModal());
  document.addEventListener('click', async e=>{
    if(e.target.closest('.del-svc-btn')){ if(confirm('Supprimer?')){await AdminServicesModule.remove(e.target.closest('.del-svc-btn').dataset.id); const s=await AdminServicesModule.listAll(); renderAdminServices((s||[]).map(parseSvcJsonFields));}}
    if(e.target.closest('.edit-svc-btn')){ openSvcModal(adminServices.find(x=>String(x.id)===e.target.closest('.edit-svc-btn').dataset.id)); }
  });
  function openSvcModal(s=null){
    editServiceId=s?s.id:null; document.getElementById('svc-modal-title').textContent=s?'Modifier':'Ajouter';
    document.getElementById('svc-title').value=s?.title||''; document.getElementById('svc-price').value=s?.price||'';
    document.getElementById('svc-image').value=s?.image_url||''; document.getElementById('svc-category').value=s?.category||'video';
    document.getElementById('svc-modal-overlay').classList.remove('hidden');
  }
  document.getElementById('svc-modal-close').addEventListener('click', ()=>document.getElementById('svc-modal-overlay').classList.add('hidden'));
  document.getElementById('svc-form').addEventListener('submit', async e=>{
    e.preventDefault();
    const p={
      title:document.getElementById('svc-title').value, category:document.getElementById('svc-category').value,
      price:parseFloat(document.getElementById('svc-price').value), image_url:document.getElementById('svc-image').value,
      is_active:document.getElementById('svc-active').checked, is_coming_soon:document.getElementById('svc-coming-soon').checked
    };
    try{await AdminServicesModule.save(p,editServiceId); document.getElementById('svc-modal-overlay').classList.add('hidden'); const s=await AdminServicesModule.listAll(); renderAdminServices((s||[]).map(parseSvcJsonFields));}catch(err){alert(err.message);}
  });
  // Service Tabs
  document.querySelectorAll('.svc-form-tab').forEach(t=>t.addEventListener('click',()=>{
    document.querySelectorAll('.svc-form-tab').forEach(x=>x.classList.remove('active','bg-brand/10','border-brand/30','text-white'));
    t.classList.add('active','bg-brand/10','border-brand/30','text-white');
    document.querySelectorAll('.svc-tab-content').forEach(c=>c.classList.add('hidden'));
    document.getElementById(`svc-tab-${t.dataset.tab}`).classList.remove('hidden');
  }));

  // --- BLOG ---
  let allBlog=[], editBlogId=null;
  async function loadBlogPosts(){try{allBlog=await AdminBlogModule.list(); renderBlog(allBlog);}catch(_){}}
  function renderBlog(posts){
    document.getElementById('blog-posts-grid').innerHTML=posts.map(p=>`
      <div class="bg-surface border border-surface-border rounded-xl p-4">
        <div class="flex justify-between mb-2"><span class="status-badge ${p.is_published?'status-done':'status-pending'}">${p.is_published?'PubliÃ©':'Brouillon'}</span></div>
        <p class="font-bold text-sm truncate mb-4">${esc(p.title)}</p>
        <div class="flex gap-2"><button class="edit-blog-btn flex-1 text-xs border border-surface-border rounded py-1" data-id="${p.id}">Modif</button><button class="del-blog-btn text-xs text-red-500 border border-surface-border rounded px-2 py-1" data-id="${p.id}"><i class="fa-solid fa-trash"></i></button></div>
      </div>`).join('');
  }
  document.getElementById('add-blog-btn').addEventListener('click', ()=>openBlogModal());
  document.addEventListener('click', async e=>{
    if(e.target.closest('.del-blog-btn')){if(confirm('Supprimer?')){await AdminBlogModule.remove(e.target.closest('.del-blog-btn').dataset.id); loadBlogPosts();}}
    if(e.target.closest('.edit-blog-btn')){openBlogModal(allBlog.find(x=>String(x.id)===e.target.closest('.edit-blog-btn').dataset.id));}
  });
  function openBlogModal(p=null){
    editBlogId=p?p.id:null; document.getElementById('blog-modal-title').textContent=p?'Modifier':'Nouveau';
    document.getElementById('blog-title').value=p?.title||''; document.getElementById('blog-slug').value=p?.slug||'';
    document.getElementById('blog-content').value=p?.content||''; document.getElementById('blog-modal-overlay').classList.remove('hidden');
    // Init TinyMCE if needed (omitted for brevity, basic textarea used)
  }
  document.getElementById('blog-modal-close').addEventListener('click', ()=>document.getElementById('blog-modal-overlay').classList.add('hidden'));
  document.getElementById('blog-form').addEventListener('submit', async e=>{
    e.preventDefault();
    const p={
      title:document.getElementById('blog-title').value, slug:document.getElementById('blog-slug').value,
      content:document.getElementById('blog-content').value, is_published:document.getElementById('blog-published').checked
    };
    try{await AdminBlogModule.save(p,editBlogId); document.getElementById('blog-modal-overlay').classList.add('hidden'); loadBlogPosts();}catch(err){alert(err.message);}
  });
  // Blog Tabs
  document.querySelectorAll('.blog-lang-tab').forEach(t=>t.addEventListener('click',()=>{
    document.querySelectorAll('.blog-lang-tab').forEach(x=>x.classList.remove('bg-brand/10','text-white','border-brand/40'));
    t.classList.add('bg-brand/10','text-white','border-brand/40');
    document.querySelectorAll('.blog-lang-fields').forEach(f=>f.classList.add('hidden'));
    document.getElementById(`blog-fields-${t.dataset.blogLang}`).classList.remove('hidden');
  }));

  // --- COMMENTS ---
  let allComments=[], commentsPage=1, commentsTotal=0;
  async function loadAdminComments(page=1){
    commentsPage=page;
    try{const {rows,count}=await AdminCommentsModule.list({page,limit:ADMIN_PAGE_LIMIT}); allComments=rows||[]; commentsTotal=count||0;}catch(_){}
    const cList=document.getElementById('comments-admin-list');
    if(!allComments.length){cList.innerHTML='<p class="text-gray-500 text-center py-10">Vide</p>';return;}
    cList.innerHTML=allComments.map(c=>`
      <div class="bg-surface border border-surface-border rounded-xl p-4 mb-2">
        <div class="flex justify-between"><span class="font-bold text-sm">${esc(c.author_name)}</span><span class="status-badge ${c.is_approved?'status-done':'status-pending'}">${c.is_approved?'OK':'Attente'}</span></div>
        <p class="text-xs text-gray-500 mb-2">${esc(c.author_email)}</p>
        <p class="text-sm text-gray-300 mb-2">${esc(c.content)}</p>
        <div class="flex gap-2">
          ${!c.is_approved?`<button class="approve-cmt-btn text-xs text-green-400" data-id="${c.id}">Approuver</button>`:''}
          <button class="del-cmt-btn text-xs text-red-500" data-id="${c.id}">Supprimer</button>
        </div>
      </div>`).join('');
    updatePager('comments-page-label','comments-prev-btn','comments-next-btn',commentsPage,commentsTotal,ADMIN_PAGE_LIMIT);
  }
  document.addEventListener('click', async e=>{
    if(e.target.classList.contains('approve-cmt-btn')){await AdminCommentsModule.approve(Number(e.target.dataset.id)); loadAdminComments(commentsPage);}
    if(e.target.classList.contains('del-cmt-btn')){if(confirm('Supprimer?'))await AdminCommentsModule.remove(Number(e.target.dataset.id)); loadAdminComments(commentsPage);}
  });
  document.getElementById('comments-prev-btn').addEventListener('click', ()=>commentsPage>1&&loadAdminComments(commentsPage-1));
  document.getElementById('comments-next-btn').addEventListener('click', ()=>commentsPage<Math.ceil(commentsTotal/ADMIN_PAGE_LIMIT)&&loadAdminComments(commentsPage+1));

  // --- USERS ---
  let usersPage=1, usersTotal=0;
  async function loadUsers(page=1){
    usersPage=page;
    try{const {rows,count}=await AdminUsersModule.list(page,ADMIN_PAGE_LIMIT); usersTotal=count||0; renderUsers(rows||[]);}catch(_){}
    updatePager('users-page-label','users-prev-btn','users-next-btn',usersPage,usersTotal,ADMIN_PAGE_LIMIT);
  }
  function renderUsers(list){
    document.getElementById('users-loading').classList.add('hidden');
    document.getElementById('users-table-wrap').classList.remove('hidden');
    document.getElementById('users-tbody').innerHTML=list.map(u=>`
      <tr class="border-b border-surface-border">
        <td class="px-5 py-3"><div class="w-8 h-8 bg-brand/10 rounded-full flex items-center justify-center text-xs font-bold text-brand">${esc((u.full_name||'?')[0])}</div></td>
        <td class="px-5 py-3 text-sm font-medium">${esc(u.full_name||'â€”')}</td>
        <td class="px-5 py-3 text-xs text-gray-400">${esc(u.id.substring(0,8))}...</td>
        <td class="px-5 py-3 text-xs text-gray-400">${esc(u.phone||'â€”')}</td>
        <td class="px-5 py-3 text-xs text-gray-500">${new Date(u.created_at).toLocaleDateString()}</td>
        <td class="px-5 py-3 flex gap-2">
          ${!u.is_banned?`<button class="ban-user-btn text-xs text-red-400" data-id="${u.id}">Ban</button>`:`<button class="unban-user-btn text-xs text-green-400" data-id="${u.id}">Unban</button>`}
        </td>
      </tr>`).join('');
  }
  document.addEventListener('click', async e=>{
    if(e.target.classList.contains('ban-user-btn')){if(confirm('Ban?')){await AdminUsersModule.ban(e.target.dataset.id); loadUsers(usersPage);}}
    if(e.target.classList.contains('unban-user-btn')){await AdminUsersModule.unban(e.target.dataset.id); loadUsers(usersPage);}
  });
  document.getElementById('users-prev-btn').addEventListener('click', ()=>usersPage>1&&loadUsers(usersPage-1));
  document.getElementById('users-next-btn').addEventListener('click', ()=>usersPage<Math.ceil(usersTotal/ADMIN_PAGE_LIMIT)&&loadUsers(usersPage+1));

  // --- SITE CONTENT ---
  async function loadSiteContent(){
    try{const d=await AdminSiteContentModule.list(); renderSiteContent(d||[]);}catch(_){}
    document.getElementById('content-loading').classList.add('hidden'); document.getElementById('content-sections').classList.remove('hidden');
  }
  function renderSiteContent(data){
    if(!data.length){document.getElementById('content-sections').innerHTML='<p class="text-center text-gray-500">Vide</p>';return;}
    const grp={}; data.forEach(i=>{const k=`${i.page}/${i.section}`; if(!grp[k])grp[k]=[]; grp[k].push(i);});
    document.getElementById('content-sections').innerHTML=Object.entries(grp).map(([g,items])=>`
      <div class="bg-surface-card border border-surface-border rounded-xl p-5">
        <h3 class="text-sm font-semibold text-gray-400 mb-4">${g}</h3>
        <div class="space-y-4">${items.map(i=>`
          <div><p class="text-xs text-brand mb-1">${i.key}</p>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
            <input class="content-input bg-surface border border-surface-border rounded px-2 py-1 text-sm text-white" data-id="${i.id}" data-lang="fr" value="${esc(i.value_fr||'')}" placeholder="FR">
            <input class="content-input bg-surface border border-surface-border rounded px-2 py-1 text-sm text-white" data-id="${i.id}" data-lang="en" value="${esc(i.value_en||'')}" placeholder="EN">
            <input class="content-input bg-surface border border-surface-border rounded px-2 py-1 text-sm text-white" data-id="${i.id}" data-lang="ar" value="${esc(i.value_ar||'')}" placeholder="AR" dir="rtl">
          </div></div>`).join('')}</div>
      </div>`).join('');
  }
  document.getElementById('save-content-btn').addEventListener('click', async ()=>{
    const u={}; document.querySelectorAll('.content-input').forEach(i=>{
      if(!u[i.dataset.id])u[i.dataset.id]={}; u[i.dataset.id][`value_${i.dataset.lang}`]=i.value;
    });
    try{await AdminSiteContentModule.saveBulk(u); alert('EnregistrÃ©');}catch(e){alert(e.message);}
  });
</script>
</body>
</html>